{
  "id": "case-02",
  "number": 2,
  "title": "The Stale Read",
  "subtitle": "An officer arrests someone on a dismissed warrant",
  "brief": {
    "narrative": "Officer Chen just arrested Marcus Webb at a traffic stop based on an outstanding warrant for assault. The problem? That warrant was dismissed by Judge Torres three hours ago. Webb's lawyer is already threatening a wrongful arrest lawsuit. The warrant dismissal was entered into the leader database at Central, but Officer Chen's patrol car queries the South Precinct follower — which apparently hasn't caught up. Chief Partition is furious. How did our own system betray us, Detective?",
    "symptoms": [
      "Warrant was dismissed 3 hours ago on the leader database",
      "South Precinct follower still shows the warrant as active",
      "North Precinct follower correctly shows the warrant as dismissed",
      "Replication lag on South Precinct follower is over 4 hours"
    ],
    "objective": "Determine why the South Precinct follower has stale data and recommend a fix to prevent officers from acting on outdated information."
  },
  "diagram": {
    "nodes": [
      {
        "id": "db-leader",
        "type": "database",
        "label": "Leader DB (Central)",
        "status": "healthy",
        "position": { "x": 350, "y": 30 },
        "inspectable": true,
        "inspectData": {
          "title": "Leader Database — Central HQ",
          "logs": [
            "[14:22:01] INFO: UPDATE warrants SET status='DISMISSED' WHERE id=W-4471",
            "[14:22:01] INFO: Write acknowledged, replicating to followers...",
            "[14:22:02] INFO: Replication to north-follower: OK (lag: 200ms)",
            "[14:22:02] WARN: Replication to south-follower: PENDING (lag: 4h 12m)",
            "[17:30:00] INFO: South follower replication still behind by 4+ hours"
          ],
          "data": {
            "Status": "ONLINE",
            "Warrant W-4471": "DISMISSED (updated 3h ago)",
            "Replication Mode": "Asynchronous",
            "North Follower Lag": "200ms",
            "South Follower Lag": "4h 12m"
          },
          "status": "Leader is healthy. South follower has severe replication lag."
        }
      },
      {
        "id": "db-north",
        "type": "database",
        "label": "North Follower",
        "status": "healthy",
        "position": { "x": 100, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "North Precinct Follower DB",
          "logs": [
            "[14:22:02] INFO: Received replication event for W-4471",
            "[14:22:02] INFO: Applied: warrant W-4471 → DISMISSED",
            "[17:30:00] INFO: Replication lag: 180ms"
          ],
          "data": {
            "Status": "ONLINE — IN SYNC",
            "Warrant W-4471": "DISMISSED",
            "Replication Lag": "180ms",
            "Last Sync": "Just now"
          },
          "status": "Healthy and up-to-date with leader."
        }
      },
      {
        "id": "db-south",
        "type": "database",
        "label": "South Follower",
        "status": "degraded",
        "position": { "x": 600, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "South Precinct Follower DB",
          "logs": [
            "[13:18:00] WARN: Replication consumer falling behind",
            "[13:45:00] WARN: Replication lag exceeding 1 hour",
            "[14:22:02] INFO: Replication event for W-4471 QUEUED (not yet applied)",
            "[17:30:00] ERROR: Replication lag: 4h 12m — serving stale data"
          ],
          "data": {
            "Status": "ONLINE — LAGGING",
            "Warrant W-4471": "ACTIVE ⚠️ (stale!)",
            "Replication Lag": "4h 12m",
            "Last Sync": "4 hours ago",
            "Cause": "Slow disk I/O on follower"
          },
          "status": "Online but severely behind. Serving stale warrant data."
        }
      },
      {
        "id": "officer-chen",
        "type": "client",
        "label": "Officer Chen",
        "status": "degraded",
        "position": { "x": 600, "y": 380 },
        "inspectable": true,
        "inspectData": {
          "title": "Officer Chen's Patrol Terminal",
          "logs": [
            "[17:25:00] INFO: Querying warrants for Marcus Webb...",
            "[17:25:00] INFO: Routed to south-follower (nearest)",
            "[17:25:01] INFO: Result: Warrant W-4471 — ACTIVE",
            "[17:25:15] INFO: Arrest initiated based on active warrant"
          ],
          "data": {
            "Connected To": "South Precinct Follower",
            "Query Result": "Warrant W-4471: ACTIVE",
            "Actual Status": "DISMISSED (3 hours ago)"
          },
          "status": "Read stale data from lagging follower. Wrongful arrest."
        }
      },
      {
        "id": "judge",
        "type": "client",
        "label": "Judge Torres",
        "status": "healthy",
        "position": { "x": 350, "y": 380 },
        "inspectable": true,
        "inspectData": {
          "title": "Judge Torres' Terminal",
          "logs": [
            "[14:22:00] INFO: Dismissing warrant W-4471 for Marcus Webb",
            "[14:22:01] INFO: Write sent to Leader DB — acknowledged"
          ],
          "data": {
            "Action": "Warrant W-4471 DISMISSED",
            "Written To": "Leader DB (Central)",
            "Time": "3 hours ago"
          },
          "status": "Dismissal was correctly written to the leader database."
        }
      }
    ],
    "edges": [
      {
        "id": "e-judge-leader",
        "source": "judge",
        "target": "db-leader",
        "label": "write",
        "animated": true,
        "style": "normal"
      },
      {
        "id": "e-leader-north",
        "source": "db-leader",
        "target": "db-north",
        "label": "replication (fast)",
        "animated": true,
        "style": "normal"
      },
      {
        "id": "e-leader-south",
        "source": "db-leader",
        "target": "db-south",
        "label": "replication (lagging!)",
        "animated": true,
        "style": "slow"
      },
      {
        "id": "e-south-chen",
        "source": "db-south",
        "target": "officer-chen",
        "label": "stale read",
        "animated": false,
        "style": "broken"
      }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Why did Officer Chen see an active warrant that had already been dismissed?",
      "options": [
        {
          "id": "rc-3",
          "text": "A network partition blocked the South Precinct from receiving any database updates from the leader node",
          "correct": false,
          "feedback": "The South follower is online and receiving replication events — they're just delayed. The logs show events are queued, not blocked. This is replication lag, not a network partition."
        },
        {
          "id": "rc-4",
          "text": "The leader database contained a software bug that caused it to not forward warrant updates to the South follower",
          "correct": false,
          "feedback": "The leader logs show the replication event was sent but is PENDING on the south follower. The follower received it but hasn't applied it yet due to its own lag."
        },
        {
          "id": "rc-2",
          "text": "Officer Chen's terminal was routed to a follower database with high replication lag, serving stale data",
          "correct": true,
          "feedback": "Correct! The South Precinct follower had 4+ hours of replication lag. When Officer Chen queried it, the warrant dismissal hadn't been replicated yet. This is the 'stale read' problem in leader-follower replication — followers may serve outdated data."
        },
        {
          "id": "rc-1",
          "text": "The judge's warrant dismissal was never saved because the write transaction to the leader database failed silently",
          "correct": false,
          "feedback": "The leader database logs confirm the warrant was updated to DISMISSED. The write succeeded — the issue is on the read side."
        }
      ]
    },
    "fix": {
      "question": "What is the best approach to prevent officers from acting on stale warrant data?",
      "options": [
        {
          "id": "fix-4",
          "text": "Cache the warrant status locally on each officer terminal to reduce database load and speed up queries",
          "correct": false,
          "feedback": "Local caching would make the staleness problem even worse! If the database is already lagging, adding another layer of caching means data could be even more out of date."
        },
        {
          "id": "fix-1",
          "text": "Route critical queries (like warrant checks) to the leader database instead of followers",
          "correct": true,
          "feedback": "Correct! For safety-critical reads like warrant status, querying the leader ensures you always get the most current data. This is the 'read-from-leader' pattern for critical queries. Less-critical queries (like statistics) can still use followers to distribute load."
        },
        {
          "id": "fix-3",
          "text": "Add additional follower databases across more precincts to help distribute the overall read query load",
          "correct": false,
          "feedback": "More followers don't solve replication lag — they could make it worse. The issue isn't load; it's that the South follower is behind and serving stale data for critical queries."
        },
        {
          "id": "fix-2",
          "text": "Switch all followers from asynchronous to synchronous replication so writes are confirmed across all replicas",
          "correct": false,
          "feedback": "Synchronous replication would ensure all followers are up-to-date, but it means every write must wait for ALL followers to confirm — including the slow South follower. This would make the entire system as slow as the slowest follower. A better approach is selective: route critical reads to the leader."
        }
      ]
    }
  },
  "conceptId": "leader-follower-replication",
  "badge": {
    "name": "Lag Hunter",
    "icon": "⏱️"
  }
}
