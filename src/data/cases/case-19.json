{
  "id": "case-19",
  "number": 19,
  "title": "The Double Arrest",
  "subtitle": "Duplicate message delivery causes the same warrant to be processed twice",
  "brief": {
    "narrative": "Officer Martinez just arrested suspect James Kowalski on warrant #W-8834 at 4th and Main. Five minutes later, Officer Chen arrested the same James Kowalski on the same warrant #W-8834 at a different location ‚Äî because the dispatch queue delivered the arrest warrant message twice. The warrant processing system created two arrest records, dispatched two units, and now there's a wrongful detention complaint. The message queue's 'at-least-once' delivery guarantee means it sometimes re-delivers messages after a timeout, and the warrant processor blindly executes every message it receives without checking for duplicates. Chief Partition wants to know why the system can't handle a simple re-delivery without making the same arrest twice, Detective.",
    "symptoms": [
      "Same arrest warrant #W-8834 processed and dispatched twice",
      "Two officers arrested the same suspect independently",
      "Duplicate arrest record created in the booking system",
      "Message queue re-delivered the warrant message after a consumer timeout"
    ],
    "objective": "Identify why duplicate message delivery caused duplicate processing and recommend an idempotency strategy."
  },
  "diagram": {
    "nodes": [
      {
        "id": "warrant-system",
        "type": "server",
        "label": "Warrant Issuing System",
        "status": "healthy",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Warrant Issuing System",
          "logs": [
            "[16:00:00] INFO: Warrant #W-8834 issued for James Kowalski",
            "[16:00:01] INFO: Message published to dispatch queue (message-id: msg-7721)"
          ],
          "data": {
            "Warrant": "#W-8834",
            "Suspect": "James Kowalski",
            "Messages Published": "1 (single publish)",
            "Status": "HEALTHY"
          },
          "status": "Published exactly one message. The duplication happened downstream."
        }
      },
      {
        "id": "message-queue",
        "type": "server",
        "label": "Dispatch Queue",
        "status": "degraded",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Dispatch Message Queue",
          "logs": [
            "[16:00:01] INFO: Message msg-7721 received and queued",
            "[16:00:02] INFO: Message msg-7721 delivered to consumer (attempt 1)",
            "[16:00:32] WARN: No ACK received within 30s timeout ‚Äî assuming consumer failed",
            "[16:00:33] INFO: Message msg-7721 re-delivered to consumer (attempt 2)",
            "[16:00:35] INFO: ACK received for msg-7721 (from attempt 1, delayed)"
          ],
          "data": {
            "Delivery Guarantee": "At-least-once",
            "Message ID": "msg-7721",
            "Deliveries": "2 (original + re-delivery)",
            "ACK Timeout": "30 seconds",
            "Status": "WORKING AS DESIGNED (at-least-once)"
          },
          "status": "Queue re-delivered message after ACK timeout. This is expected at-least-once behavior."
        }
      },
      {
        "id": "warrant-processor",
        "type": "server",
        "label": "Warrant Processor",
        "status": "degraded",
        "position": { "x": 600, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Warrant Processor Service",
          "logs": [
            "[16:00:02] INFO: Processing warrant #W-8834 (message attempt 1)",
            "[16:00:05] INFO: Arrest record created ‚Äî booking #BK-1190",
            "[16:00:06] INFO: Unit dispatched to execute warrant #W-8834",
            "[16:00:33] INFO: Processing warrant #W-8834 (message attempt 2 ‚Äî DUPLICATE)",
            "[16:00:35] INFO: Arrest record created ‚Äî booking #BK-1191 (DUPLICATE)",
            "[16:00:36] INFO: Second unit dispatched for same warrant #W-8834"
          ],
          "data": {
            "Idempotency Check": "NONE",
            "Processed Message IDs": "Not tracked",
            "Duplicate Detection": "Not implemented",
            "Bookings Created": "2 (should be 1)",
            "Units Dispatched": "2 (should be 1)"
          },
          "status": "Processed both deliveries as new ‚Äî no duplicate detection."
        }
      },
      {
        "id": "booking-db",
        "type": "database",
        "label": "Booking Database",
        "status": "degraded",
        "position": { "x": 350, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Booking Database",
          "logs": [
            "[16:00:05] INFO: INSERT booking #BK-1190 (warrant #W-8834)",
            "[16:00:35] INFO: INSERT booking #BK-1191 (warrant #W-8834) ‚Äî DUPLICATE"
          ],
          "data": {
            "Booking #BK-1190": "Warrant #W-8834 ‚Äî James Kowalski",
            "Booking #BK-1191": "Warrant #W-8834 ‚Äî James Kowalski (DUPLICATE)",
            "Unique Constraint on Warrant": "NOT CONFIGURED",
            "Total Duplicate Records": "1 pair"
          },
          "status": "Two booking records for the same warrant. No uniqueness constraint."
        }
      },
      {
        "id": "officers",
        "type": "client",
        "label": "Patrol Officers",
        "status": "degraded",
        "position": { "x": 600, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Patrol Officers",
          "logs": [
            "[16:05:00] INFO: Officer Martinez arrested J. Kowalski at 4th & Main",
            "[16:10:00] INFO: Officer Chen arrested J. Kowalski at 7th & Oak (DUPLICATE)"
          ],
          "data": {
            "Arrests for #W-8834": "2 (should be 1)",
            "Officers Dispatched": "2 (should be 1)",
            "Wrongful Detention Complaint": "Filed"
          },
          "status": "Two officers independently arrested the same person on the same warrant."
        }
      }
    ],
    "edges": [
      { "id": "e-warrant-queue", "source": "warrant-system", "target": "message-queue", "label": "publish (1x)", "animated": true, "style": "normal" },
      { "id": "e-queue-processor", "source": "message-queue", "target": "warrant-processor", "label": "delivered 2x", "animated": true, "style": "slow" },
      { "id": "e-processor-db", "source": "warrant-processor", "target": "booking-db", "label": "duplicate writes", "animated": true, "style": "slow" },
      { "id": "e-processor-officers", "source": "warrant-processor", "target": "officers", "label": "duplicate dispatch", "animated": true, "style": "slow" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "What is the root cause of the double arrest?",
      "options": [
        {
          "id": "rc-1",
          "text": "The warrant issuing system accidentally published the message twice",
          "correct": false,
          "feedback": "The warrant system published exactly one message. The duplication happened because the queue re-delivered the message after an ACK timeout ‚Äî which is normal 'at-least-once' delivery behavior."
        },
        {
          "id": "rc-2",
          "text": "The warrant processor lacks idempotency ‚Äî it processes every message as new without checking if it already handled that warrant",
          "correct": true,
          "feedback": "Correct! The warrant processor blindly processes every message it receives without tracking which warrants it has already handled. In an at-least-once delivery system, duplicate deliveries are expected. Consumers must be idempotent ‚Äî they must detect and safely handle duplicate messages to produce the same result regardless of how many times a message is delivered."
        },
        {
          "id": "rc-3",
          "text": "The message queue has a bug causing it to deliver messages twice",
          "correct": false,
          "feedback": "The queue is working as designed. At-least-once delivery guarantees that messages are never lost, but it means they may be delivered more than once (e.g., after ACK timeouts). This is a known trade-off, and consumers must be designed to handle it."
        },
        {
          "id": "rc-4",
          "text": "The ACK timeout of 30 seconds is too short, causing premature re-delivery",
          "correct": false,
          "feedback": "A longer timeout would reduce the frequency of re-deliveries but cannot eliminate them. Network issues, consumer restarts, and other failures can all trigger re-delivery. The consumer must be idempotent regardless of timeout settings."
        }
      ]
    },
    "fix": {
      "question": "What is the best fix to prevent duplicate processing of re-delivered messages?",
      "options": [
        {
          "id": "fix-1",
          "text": "Switch to exactly-once delivery in the message queue",
          "correct": false,
          "feedback": "True exactly-once delivery is extremely difficult to achieve in distributed systems and most queue implementations don't support it. The standard approach is at-least-once delivery combined with idempotent consumers. It's simpler and more reliable."
        },
        {
          "id": "fix-2",
          "text": "Make the warrant processor idempotent ‚Äî track processed message/warrant IDs and skip duplicates",
          "correct": true,
          "feedback": "Correct! An idempotent consumer tracks which messages (or business keys like warrant IDs) it has already processed. When a duplicate arrives, it recognizes it and skips processing. This can be done with a processed-message table, a unique constraint on warrant ID in the booking database, or an idempotency key. The result is the same whether a message is delivered once or ten times."
        },
        {
          "id": "fix-3",
          "text": "Increase the ACK timeout to 5 minutes to prevent premature re-delivery",
          "correct": false,
          "feedback": "A longer timeout reduces re-deliveries but introduces a worse problem: if a consumer genuinely crashes, the message won't be re-delivered for 5 minutes. And duplicates can still happen from other causes (network partitions, consumer restarts). Idempotency is the robust solution."
        },
        {
          "id": "fix-4",
          "text": "Add a deduplication layer in the message queue to filter duplicate deliveries",
          "correct": false,
          "feedback": "Queue-level deduplication can help but only catches re-deliveries of the exact same message. It doesn't protect against application-level duplicates or different messages for the same business entity. Consumer-side idempotency is the more comprehensive and reliable approach."
        }
      ]
    }
  },
  "conceptId": "idempotency",
  "badge": {
    "name": "Dedup Detective",
    "icon": "üîç"
  }
}