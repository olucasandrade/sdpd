{
  "id": "case-31",
  "number": 31,
  "title": "The Phantom Read",
  "subtitle": "The crime statistics that changed mid-count",
  "brief": {
    "narrative": "Commissioner Data is presenting the quarterly crime statistics to the City Council of Distributia. The numbers look great â€” violent crime down 15%. But halfway through the presentation, Council Member Chen pulls up the same report from the public dashboard and challenges the numbers: her copy shows violent crime up 3%. The Commissioner runs the report again live on the projector â€” and gets a third, different set of numbers. Pandemonium ensues. The investigation reveals that the Statistics Report Service reads from multiple tables over the course of several seconds. Between reads, the Crime Intake Service is actively inserting new crime reports and the Case Resolution Service is updating case statuses. The report transaction is using READ COMMITTED isolation, which means each query within the report sees the latest committed data â€” but that data is changing between queries. The violent crime count was read at 10:00:01, but the resolved cases count was read at 10:00:04, by which time 47 new crimes had been logged. The report is mixing data from different points in time, producing numbers that never simultaneously existed.",
    "symptoms": [
      "Crime statistics report produces different results each time it's run within the same minute",
      "Violent crime count and resolved cases count are inconsistent with each other",
      "Report numbers don't match the public dashboard (which ran the same query moments later)",
      "Individual queries are correct, but the combined report presents an impossible snapshot"
    ],
    "objective": "Identify how the wrong transaction isolation level causes phantom reads and inconsistent reports, and determine the correct isolation level for analytical queries."
  },
  "diagram": {
    "nodes": [
      {
        "id": "stats-service",
        "type": "server",
        "label": "Statistics Report Service",
        "status": "degraded",
        "position": {
          "x": 350,
          "y": 50
        },
        "inspectable": true,
        "inspectData": {
          "title": "Statistics Report Service",
          "logs": [
            "[10:00:01] INFO: Starting quarterly report â€” Transaction isolation: READ COMMITTED",
            "[10:00:01] INFO: Query 1 â€” SELECT COUNT(*) FROM crimes WHERE type='violent' â†’ 1,247",
            "[10:00:02] INFO: Query 2 â€” SELECT COUNT(*) FROM crimes WHERE type='property' â†’ 3,891",
            "[10:00:03] INFO: Query 3 â€” SELECT COUNT(*) FROM cases WHERE status='resolved' â†’ 4,102",
            "[10:00:04] INFO: Query 4 â€” SELECT COUNT(*) FROM crimes (total) â†’ 5,185",
            "[10:00:04] WARN: Data inconsistency â€” violent(1,247) + property(3,891) = 5,138, but total = 5,185",
            "[10:00:04] INFO: Report generated â€” but 47 crimes appeared between Query 1 and Query 4"
          ],
          "data": {
            "Isolation Level": "READ COMMITTED",
            "Transaction Duration": "3.2 seconds",
            "Queries Per Report": "12",
            "Snapshot Consistency": "NONE â€” each query sees latest committed data",
            "Data Changed During Tx": "47 new crimes, 13 case updates"
          },
          "status": "Report assembles data from different points in time. Each query is correct individually, but the combined result is inconsistent."
        }
      },
      {
        "id": "crime-intake",
        "type": "server",
        "label": "Crime Intake Service",
        "status": "healthy",
        "position": {
          "x": 80,
          "y": 200
        },
        "inspectable": true,
        "inspectData": {
          "title": "Crime Intake Service",
          "logs": [
            "[10:00:01] INFO: INSERT crime #8291 â€” type=violent â€” COMMITTED",
            "[10:00:02] INFO: INSERT crime #8292 â€” type=property â€” COMMITTED",
            "[10:00:02] INFO: INSERT crime #8293 â€” type=violent â€” COMMITTED",
            "[10:00:03] INFO: INSERT crimes #8294-#8338 â€” batch import from precinct 7 â€” COMMITTED",
            "[10:00:04] INFO: INSERT crime #8339 â€” type=property â€” COMMITTED"
          ],
          "data": {
            "Inserts During Report Window": "47 new crime records",
            "Commit Rate": "~15 commits/second",
            "Status": "Operating normally â€” unaware of concurrent report"
          },
          "status": "Actively inserting new crime reports. Each insert is immediately visible to READ COMMITTED transactions."
        }
      },
      {
        "id": "case-resolution",
        "type": "server",
        "label": "Case Resolution Service",
        "status": "healthy",
        "position": {
          "x": 620,
          "y": 200
        },
        "inspectable": true,
        "inspectData": {
          "title": "Case Resolution Service",
          "logs": [
            "[10:00:01] INFO: UPDATE case #4411 â€” status='resolved' â€” COMMITTED",
            "[10:00:02] INFO: UPDATE case #4415 â€” status='resolved' â€” COMMITTED",
            "[10:00:03] INFO: UPDATE cases #4420-#4432 â€” batch resolution â€” COMMITTED"
          ],
          "data": {
            "Updates During Report Window": "13 case status changes",
            "Status": "Operating normally",
            "Commit Rate": "~4 commits/second"
          },
          "status": "Actively updating case statuses. Changes are visible to subsequent queries in the report transaction."
        }
      },
      {
        "id": "crime-db",
        "type": "database",
        "label": "Crime Database",
        "status": "healthy",
        "position": {
          "x": 350,
          "y": 350
        },
        "inspectable": true,
        "inspectData": {
          "title": "Crime Statistics Database",
          "logs": [
            "[10:00:01] INFO: Report transaction started â€” isolation=READ_COMMITTED",
            "[10:00:01] INFO: Concurrent write transactions active: 8",
            "[10:00:04] INFO: Report transaction completed â€” 12 queries executed",
            "[10:00:04] INFO: During report tx: 47 inserts, 13 updates committed by other transactions"
          ],
          "data": {
            "Isolation Level": "READ COMMITTED (default)",
            "MVCC": "Enabled but each statement sees latest snapshot",
            "Concurrent Transactions": "8 active writers during report",
            "Snapshot Isolation": "NOT ENABLED"
          },
          "status": "Database is healthy. READ COMMITTED provides per-statement consistency but not per-transaction consistency."
        }
      }
    ],
    "edges": [
      {
        "id": "e-stats-db",
        "source": "stats-service",
        "target": "crime-db",
        "label": "12 queries (3.2s)",
        "animated": true,
        "style": "slow"
      },
      {
        "id": "e-intake-db",
        "source": "crime-intake",
        "target": "crime-db",
        "label": "47 inserts",
        "animated": true,
        "style": "normal"
      },
      {
        "id": "e-resolution-db",
        "source": "case-resolution",
        "target": "crime-db",
        "label": "13 updates",
        "animated": true,
        "style": "normal"
      }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "What is the root cause of the inconsistent crime statistics report?",
      "options": [
        {
          "id": "rc-1",
          "text": "The Crime Intake Service is inserting records too rapidly, causing corruption in the database index structures, preventing the report from showing accurate data.",
          "correct": false,
          "feedback": "The database is functioning perfectly â€” no corruption, no bugs. Each insert and update is properly committed. The problem is that the report transaction sees different committed data at different moments because READ COMMITTED isolation gives each query its own snapshot."
        },
        {
          "id": "rc-2",
          "text": "READ COMMITTED isolation allows each query within the report transaction to see newly committed data, causing phantom reads across the multi-query report",
          "correct": true,
          "feedback": "Correct! Under READ COMMITTED isolation, each SQL statement sees all data committed up to the moment that statement starts executing. Since the report runs 12 queries over 3.2 seconds, and other transactions are committing changes between those queries, each query in the report sees a slightly different version of the data. This is the phantom read problem â€” rows that didn't exist when the transaction started 'appear' in later queries, producing a report that mixes data from different points in time."
        },
        {
          "id": "rc-3",
          "text": "The report's SQL queries are poorly written and don't properly JOIN all the required crime statistic tables",
          "correct": false,
          "feedback": "Each individual query is correct and returns accurate results at the moment it executes. The inconsistency arises because the data changes between queries. Better SQL won't help if the isolation level allows the underlying data to shift mid-transaction."
        },
        {
          "id": "rc-4",
          "text": "The database is severely overloaded with traffic, causing all reporting queries to return old cached or stale results",
          "correct": false,
          "feedback": "The database is not returning stale data â€” quite the opposite! It's returning data that's too fresh. Each query returns the latest committed state, which includes changes made by other transactions since the report started. The problem is that 'latest' changes between queries."
        }
      ]
    },
    "fix": {
      "question": "What is the best fix to ensure the crime statistics report reads consistent data?",
      "options": [
        {
          "id": "fix-4",
          "text": "Acquire an exclusive table-level lock on the crimes table before generating the report to prevent all concurrent modifications",
          "correct": false,
          "feedback": "Table-level locking would provide consistency but would block all crime intake during report generation â€” unacceptable for a police department where every second counts. SNAPSHOT isolation achieves the same consistency without blocking any writers through MVCC (Multi-Version Concurrency Control)."
        },
        {
          "id": "fix-1",
          "text": "Upgrade to SERIALIZABLE isolation so the report transaction fully serializes and blocks all concurrent writes while it runs",
          "correct": false,
          "feedback": "SERIALIZABLE would provide consistency, but it's overkill and would block all crime intake and case resolution for the 3+ seconds the report runs. For a read-only analytical query, you don't need to block writers â€” you just need a consistent point-in-time snapshot."
        },
        {
          "id": "fix-2",
          "text": "Refactor all 12 report queries into a single combined SQL statement using subqueries so they all execute atomically",
          "correct": false,
          "feedback": "Combining queries into one statement helps under READ COMMITTED (single statement = single snapshot), but it's fragile â€” complex reports may need multiple statements, and this approach breaks down for reports that can't be expressed as a single query. The proper fix is at the isolation level."
        },
        {
          "id": "fix-3",
          "text": "Use REPEATABLE READ or SNAPSHOT isolation so all queries in the report transaction see the same point-in-time snapshot",
          "correct": true,
          "feedback": "Correct! REPEATABLE READ (or SNAPSHOT isolation in databases that support it) ensures all queries within a transaction see the database as it was at the moment the transaction began. New inserts and updates committed by other transactions are invisible to the report. This eliminates phantom reads â€” the report sees a consistent snapshot even though the underlying data is being modified. Writers are not blocked, so the system remains fully operational."
        }
      ]
    }
  },
  "conceptId": "isolation-levels",
  "badge": {
    "name": "Isolation Expert",
    "icon": "ðŸ”¬"
  }
}