{
  "id": "case-04",
  "number": 4,
  "title": "O C√©rebro Dividido",
  "subtitle": "Duas delegacias, duas verdades, uma rede partida",
  "brief": {
    "narrative": "O caos toma conta da sede da Pol√≠cia de Distributia. Um corte de fibra entre os data centers Leste e Oeste rompeu o link de rede entre as duas r√©plicas do banco de dados. Ambas as r√©plicas se autopromoveram a l√≠der, e agora as Delegacias Leste e Oeste est√£o gravando registros conflitantes em seus respectivos bancos de dados. O Oficial Martinez acabou de liberar um suspeito que a Delegacia Oeste havia marcado para pris√£o ‚Äî porque o banco de dados da Delegacia Leste mostra o suspeito como liberado. O Chefe Partition est√° furioso. Dois bancos de dados, duas vers√µes da verdade, e ningu√©m sabe qual est√° certa.",
    "symptoms": [
      "As r√©plicas Leste e Oeste do banco de dados se declaram como l√≠der prim√°rio",
      "Registros criminais conflitantes entre as duas delegacias",
      "Um suspeito marcado para pris√£o na Delegacia Oeste foi dado como liberado na Leste",
      "O link de rede entre os dois data centers est√° fora do ar"
    ],
    "objective": "Identificar como uma parti√ß√£o de rede causou um cen√°rio de split-brain e determinar a estrat√©gia correta para resolver e prevenir escritas conflitantes."
  },
  "diagram": {
    "nodes": [
      {
        "id": "db-east",
        "type": "database",
        "label": "East DB (Leader)",
        "status": "degraded",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "R√©plica do Banco de Dados Leste",
          "logs": [
            "[03:14:01] WARN: Lost heartbeat from West DB replica",
            "[03:14:04] WARN: No response after 3 retries",
            "[03:14:05] INFO: Failover timeout reached ‚Äî promoting self to leader",
            "[03:14:05] INFO: Now accepting writes as PRIMARY",
            "[03:14:22] INFO: WRITE ‚Äî Suspect #4412 status changed to CLEARED",
            "[03:15:01] WARN: Still no contact with West DB"
          ],
          "data": {
            "Role": "PRIMARY (self-promoted)",
            "Replication Link": "DISCONNECTED",
            "Writes Since Partition": "34",
            "Last Sync With West": "03:13:58",
            "Suspect #4412 Status": "CLEARED"
          },
          "status": "Autopromovido a l√≠der ap√≥s perder contato com o DB Oeste. Aceitando escritas independentemente."
        }
      },
      {
        "id": "db-west",
        "type": "database",
        "label": "West DB (Leader)",
        "status": "degraded",
        "position": { "x": 550, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "R√©plica do Banco de Dados Oeste",
          "logs": [
            "[03:14:02] WARN: Lost heartbeat from East DB replica",
            "[03:14:05] WARN: No response after 3 retries",
            "[03:14:06] INFO: Failover timeout reached ‚Äî promoting self to leader",
            "[03:14:06] INFO: Now accepting writes as PRIMARY",
            "[03:14:18] INFO: WRITE ‚Äî Suspect #4412 status changed to ARREST WARRANT ACTIVE",
            "[03:15:02] WARN: Still no contact with East DB"
          ],
          "data": {
            "Role": "PRIMARY (self-promoted)",
            "Replication Link": "DISCONNECTED",
            "Writes Since Partition": "28",
            "Last Sync With East": "03:13:58",
            "Suspect #4412 Status": "ARREST WARRANT ACTIVE"
          },
          "status": "Autopromovido a l√≠der ap√≥s perder contato com o DB Leste. Aceitando escritas independentemente."
        }
      },
      {
        "id": "precinct-east",
        "type": "client",
        "label": "East Precinct",
        "status": "degraded",
        "position": { "x": 100, "y": 280 },
        "inspectable": true,
        "inspectData": {
          "title": "Terminal da Delegacia Leste",
          "logs": [
            "[03:14:10] INFO: Connected to East DB (primary)",
            "[03:14:22] INFO: Updated suspect #4412 ‚Äî marked CLEARED per DA office",
            "[03:15:30] WARN: Officer Martinez released suspect #4412 based on CLEARED status"
          ],
          "data": {
            "Connected To": "East DB",
            "DB Role Reported": "PRIMARY",
            "Active Officers": "14",
            "Suspect #4412": "CLEARED"
          },
          "status": "Operando normalmente contra o DB Leste, sem saber dos dados conflitantes no Oeste."
        }
      },
      {
        "id": "precinct-west",
        "type": "client",
        "label": "West Precinct",
        "status": "degraded",
        "position": { "x": 550, "y": 280 },
        "inspectable": true,
        "inspectData": {
          "title": "Terminal da Delegacia Oeste",
          "logs": [
            "[03:14:10] INFO: Connected to West DB (primary)",
            "[03:14:18] INFO: Filed arrest warrant for suspect #4412 ‚Äî new evidence from forensics",
            "[03:16:00] ERROR: Suspect #4412 was released by East Precinct ‚Äî CONFLICTING STATUS"
          ],
          "data": {
            "Connected To": "West DB",
            "DB Role Reported": "PRIMARY",
            "Active Officers": "11",
            "Suspect #4412": "ARREST WARRANT ACTIVE"
          },
          "status": "Operando normalmente contra o DB Oeste, sem saber que o suspeito foi liberado pela Delegacia Leste."
        }
      },
      {
        "id": "network-link",
        "type": "server",
        "label": "Inter-DC Network",
        "status": "failed",
        "position": { "x": 325, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Link de Rede Inter-Datacenter",
          "logs": [
            "[03:13:59] INFO: Fiber optic link healthy ‚Äî 1ms latency",
            "[03:14:00] ERROR: Physical link failure detected on fiber segment DC-E-7",
            "[03:14:00] ERROR: All packets dropped between East DC and West DC",
            "[03:14:01] WARN: No redundant path available"
          ],
          "data": {
            "Link Status": "DOWN",
            "Cause": "Fiber cut ‚Äî construction crew on 5th Avenue",
            "Packets Dropped": "100%",
            "Redundant Path": "None configured",
            "Estimated Repair": "4-6 hours"
          },
          "status": "Corte f√≠sico na fibra. Sem caminho de rede redundante entre os data centers."
        }
      }
    ],
    "edges": [
      { "id": "e-east-db-link", "source": "db-east", "target": "network-link", "label": "replication", "animated": false, "style": "broken" },
      { "id": "e-link-west-db", "source": "network-link", "target": "db-west", "label": "replication", "animated": false, "style": "broken" },
      { "id": "e-east-precinct", "source": "db-east", "target": "precinct-east", "label": "queries/writes", "animated": true, "style": "normal" },
      { "id": "e-west-precinct", "source": "db-west", "target": "precinct-west", "label": "queries/writes", "animated": true, "style": "normal" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz dos registros conflitantes do suspeito?",
      "options": [
        {
          "id": "rc-1",
          "text": "Um bug de software fez os bancos de dados corromperem e gravarem dados incorretos no registro do suspeito #4412",
          "correct": false,
          "feedback": "Os bancos de dados est√£o funcionando corretamente individualmente. O problema √© que uma parti√ß√£o de rede fez ambas as r√©plicas se autopromoverem a l√≠der, criando um cen√°rio de split-brain onde cada uma aceita escritas conflitantes."
        },
        {
          "id": "rc-2",
          "text": "Uma parti√ß√£o de rede causou um split-brain ‚Äî ambos os bancos de dados se autopromoveram a l√≠der e aceitaram escritas conflitantes independentemente",
          "correct": true,
          "feedback": "Correto! Quando o link de rede entre os dois data centers falhou, cada r√©plica perdeu contato com a outra. Sem um mecanismo adequado de qu√≥rum ou isolamento, ambas se promoveram a l√≠der. Este √© o cl√°ssico problema de 'split-brain' em sistemas distribu√≠dos ‚Äî uma parti√ß√£o de rede leva a dois l√≠deres independentes aceitando escritas conflitantes."
        },
        {
          "id": "rc-3",
          "text": "O policial da Delegacia Leste realizou uma altera√ß√£o n√£o autorizada no status do suspeito sem aprova√ß√£o, por isso o sistema n√£o conseguiu sincronizar os dados entre os dois bancos de dados",
          "correct": false,
          "feedback": "O policial da Delegacia Leste seguiu o procedimento correto ‚Äî o Minist√©rio P√∫blico liberou o suspeito. O problema √© que a Delegacia Oeste simultaneamente emitiu um mandado de pris√£o, e os dois bancos de dados n√£o estavam se comunicando devido √† parti√ß√£o de rede. Ambas as escritas eram leg√≠timas, por√©m conflitantes."
        },
        {
          "id": "rc-4",
          "text": "O timeout de failover estava configurado muito baixo, causando a promo√ß√£o prematura e incorreta a l√≠der, da qual n√£o foi poss√≠vel reverter",
          "correct": false,
          "feedback": "Embora um timeout maior possa atrasar o split-brain, n√£o o preveniria. A quest√£o central √© a falta de um mecanismo adequado de consenso ou requisito de qu√≥rum. Sem isso, qualquer valor de timeout eventualmente leva ao mesmo problema durante uma parti√ß√£o prolongada."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor abordagem para prevenir cen√°rios de split-brain?",
      "options": [
        {
          "id": "fix-1",
          "text": "Implementar um protocolo de consenso baseado em qu√≥rum ‚Äî exigir que a maioria dos n√≥s concorde antes de eleger um l√≠der",
          "correct": true,
          "feedback": "Correto! Com um qu√≥rum (ex.: 3 n√≥s onde 2 devem concordar), uma √∫nica parti√ß√£o n√£o pode produzir dois l√≠deres. O lado com a maioria continua operando, enquanto o lado minorit√°rio recusa escritas. Esta √© a base dos protocolos de consenso como Raft e Paxos, e √© por isso que clusters de produ√ß√£o usam um n√∫mero √≠mpar de n√≥s."
        },
        {
          "id": "fix-2",
          "text": "Adicionar um segundo link de rede f√≠sico redundante entre os data centers para evitar parti√ß√µes",
          "correct": false,
          "feedback": "Um link de rede redundante reduz a chance de uma parti√ß√£o mas n√£o a elimina. Ambos os links podem falhar (mesma canaleta de cabos, mesmo provedor). Voc√™ ainda precisa de um mecanismo adequado de consenso para quando parti√ß√µes inevitavelmente ocorrerem ‚Äî redund√¢ncia de rede √© complemento, n√£o substituto."
        },
        {
          "id": "fix-3",
          "text": "Definir um banco de dados como prim√°rio permanente e nunca permitir nenhum tipo de failover autom√°tico",
          "correct": false,
          "feedback": "Isso previne split-brain mas sacrifica a disponibilidade completamente ‚Äî se o prim√°rio permanente falhar, o sistema inteiro fica fora do ar (voltando ao ponto √∫nico de falha). Uma abordagem baseada em qu√≥rum oferece tanto seguran√ßa quanto disponibilidade."
        },
        {
          "id": "fix-4",
          "text": "Usar timestamps para resolver conflitos automaticamente, mantendo sempre a escrita com o hor√°rio mais recente",
          "correct": false,
          "feedback": "Last-write-wins (LWW) √© uma estrat√©gia de resolu√ß√£o de conflitos, mas n√£o previne o split-brain. Ela descarta silenciosamente uma escrita, o que pode significar descartar silenciosamente um mandado de pris√£o. Para dados cr√≠ticos como registros criminais, o ideal √© prevenir escritas conflitantes em primeiro lugar, n√£o resolv√™-las depois."
        }
      ]
    }
  },
  "conceptId": "network-partitions",
  "badge": {
    "name": "Patrulha de Parti√ß√µes",
    "icon": "üß©"
  }
}
