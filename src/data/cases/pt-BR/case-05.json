{
  "id": "case-05",
  "number": 5,
  "title": "O Voto Fantasma",
  "subtitle": "Bloqueio da sala de evid√™ncias falha quando m√∫ltiplos n√≥s reivindicam lideran√ßa",
  "brief": {
    "narrative": "A sala de evid√™ncias da Pol√≠cia de Distributia usa um servi√ßo de lock distribu√≠do para garantir que apenas um funcion√°rio possa retirar uma pe√ßa de evid√™ncia por vez. Hoje √† noite, o n√≥ l√≠der do servi√ßo de lock caiu em um momento cr√≠tico ‚Äî bem no meio de uma elei√ß√£o de l√≠der. Agora tr√™s n√≥s acreditam ser o novo l√≠der, e tr√™s funcion√°rios diferentes receberam acesso simult√¢neo √† mesma arma do crime (Evid√™ncia #7781). A cadeia de cust√≥dia foi comprometida. O advogado de defesa j√° est√° entrando com mo√ß√£o para anular o caso. Detetive, desemaranhe esse desastre eleitoral antes que o caso desmorone.",
    "symptoms": [
      "Tr√™s n√≥s do servi√ßo de lock reivindicam ser o l√≠der",
      "A Evid√™ncia #7781 foi retirada simultaneamente por tr√™s funcion√°rios diferentes",
      "A integridade da cadeia de cust√≥dia foi violada",
      "O servi√ßo de lock est√° concedendo locks conflitantes para os mesmos itens de evid√™ncia"
    ],
    "objective": "Determinar como o processo de elei√ß√£o de l√≠der falhou e identificar o mecanismo adequado para garantir que exatamente um l√≠der seja eleito."
  },
  "diagram": {
    "nodes": [
      {
        "id": "lock-node-1",
        "type": "server",
        "label": "Lock Node 1",
        "status": "degraded",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "N√≥ 1 do Servi√ßo de Lock",
          "logs": [
            "[21:30:00] INFO: Leader (Node 0) heartbeat received",
            "[21:30:05] WARN: Leader heartbeat missed",
            "[21:30:08] WARN: Leader heartbeat missed (2nd)",
            "[21:30:10] INFO: Election timeout reached ‚Äî starting election for term 4",
            "[21:30:10] INFO: Voted for SELF in term 4",
            "[21:30:11] INFO: Received vote from Node 3 for term 4",
            "[21:30:11] INFO: Received 2/5 votes ‚Äî declaring self LEADER",
            "[21:30:12] WARN: Node 2 also claims leadership for term 4"
          ],
          "data": {
            "Role": "LEADER (self-declared)",
            "Term": "4",
            "Votes Received": "2 of 5 (self + Node 3)",
            "Quorum Required": "3 of 5",
            "Quorum Met": "NO",
            "Locks Granted": "Evidence #7781 ‚Üí Clerk Adams"
          },
          "status": "Declarou lideran√ßa com apenas 2/5 votos ‚Äî qu√≥rum de 3 N√ÉO foi atingido."
        }
      },
      {
        "id": "lock-node-2",
        "type": "server",
        "label": "Lock Node 2",
        "status": "degraded",
        "position": { "x": 400, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "N√≥ 2 do Servi√ßo de Lock",
          "logs": [
            "[21:30:00] INFO: Leader (Node 0) heartbeat received",
            "[21:30:06] WARN: Leader heartbeat missed",
            "[21:30:09] INFO: Election timeout reached ‚Äî starting election for term 4",
            "[21:30:09] INFO: Voted for SELF in term 4",
            "[21:30:10] INFO: Received vote from Node 4 for term 4",
            "[21:30:10] INFO: Received 2/5 votes ‚Äî declaring self LEADER",
            "[21:30:11] WARN: Node 1 also claims leadership for term 4"
          ],
          "data": {
            "Role": "LEADER (self-declared)",
            "Term": "4",
            "Votes Received": "2 of 5 (self + Node 4)",
            "Quorum Required": "3 of 5",
            "Quorum Met": "NO",
            "Locks Granted": "Evidence #7781 ‚Üí Clerk Baker"
          },
          "status": "Declarou lideran√ßa com apenas 2/5 votos ‚Äî qu√≥rum de 3 N√ÉO foi atingido."
        }
      },
      {
        "id": "lock-node-0",
        "type": "server",
        "label": "Lock Node 0 (Old Leader)",
        "status": "failed",
        "position": { "x": 250, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "N√≥ 0 do Servi√ßo de Lock (Antigo L√≠der)",
          "logs": [
            "[21:29:55] INFO: Operating as LEADER for term 3",
            "[21:29:58] INFO: Sending heartbeat to followers",
            "[21:30:00] ERROR: Out of memory ‚Äî process killed by OOM killer",
            "[21:30:00] FATAL: Lock service process terminated"
          ],
          "data": {
            "Role": "OFFLINE (former leader)",
            "Term": "3",
            "Cause of Death": "OOM killer ‚Äî memory leak in lock table",
            "Locks Held at Crash": "12 active locks",
            "Status": "OFFLINE"
          },
          "status": "Caiu por OOM. Era o l√≠der do termo 3 antes de ficar offline."
        }
      },
      {
        "id": "evidence-room",
        "type": "client",
        "label": "Evidence Room System",
        "status": "degraded",
        "position": { "x": 250, "y": 370 },
        "inspectable": true,
        "inspectData": {
          "title": "Controle de Acesso da Sala de Evid√™ncias",
          "logs": [
            "[21:30:12] INFO: Lock granted for Evidence #7781 by Node 1 ‚Üí Clerk Adams",
            "[21:30:13] INFO: Lock granted for Evidence #7781 by Node 2 ‚Üí Clerk Baker",
            "[21:30:15] WARN: CONFLICT ‚Äî Evidence #7781 checked out by 2 clerks simultaneously",
            "[21:30:15] ERROR: Chain of custody violation detected"
          ],
          "data": {
            "Evidence #7781": "CONFLICT ‚Äî 2 concurrent checkouts",
            "Clerk Adams": "Checked out via Node 1",
            "Clerk Baker": "Checked out via Node 2",
            "Chain of Custody": "COMPROMISED",
            "Total Active Conflicts": "3 evidence items"
          },
          "status": "M√∫ltiplos n√≥s de lock concedendo locks conflitantes. Integridade da cadeia de cust√≥dia comprometida."
        }
      }
    ],
    "edges": [
      { "id": "e-node1-evidence", "source": "lock-node-1", "target": "evidence-room", "label": "lock grant", "animated": true, "style": "normal" },
      { "id": "e-node2-evidence", "source": "lock-node-2", "target": "evidence-room", "label": "lock grant", "animated": true, "style": "normal" },
      { "id": "e-node0-node1", "source": "lock-node-0", "target": "lock-node-1", "label": "heartbeat", "animated": false, "style": "broken" },
      { "id": "e-node0-node2", "source": "lock-node-0", "target": "lock-node-2", "label": "heartbeat", "animated": false, "style": "broken" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "O que fez m√∫ltiplos n√≥s reivindicarem lideran√ßa simultaneamente?",
      "options": [
        {
          "id": "rc-1",
          "text": "O antigo l√≠der (N√≥ 0) caiu e enviou dados corrompidos que confundiram os outros n√≥s",
          "correct": false,
          "feedback": "O N√≥ 0 caiu de forma limpa por OOM kill ‚Äî n√£o enviou dados corrompidos. O problema √© que os n√≥s sobreviventes iniciaram uma elei√ß√£o mas n√£o exigiram maioria adequada (qu√≥rum) antes de se declararem l√≠der."
        },
        {
          "id": "rc-2",
          "text": "O processo de elei√ß√£o n√£o exige qu√≥rum de maioria estrita ‚Äî n√≥s declararam lideran√ßa sem receber votos da maioria do cluster",
          "correct": true,
          "feedback": "Correto! Tanto o N√≥ 1 quanto o N√≥ 2 se declararam l√≠der com apenas 2 de 5 votos cada. Um protocolo de elei√ß√£o de l√≠der correto (como Raft) exige maioria estrita ‚Äî pelo menos 3 de 5 votos. Como cada n√≥ s√≥ pode votar uma vez por termo, a maioria estrita garante no m√°ximo um l√≠der por termo. O bug aqui √© que os n√≥s aceitaram lideran√ßa sem atingir qu√≥rum."
        },
        {
          "id": "rc-3",
          "text": "Ambos os n√≥s iniciaram suas elei√ß√µes exatamente ao mesmo tempo, causando uma condi√ß√£o de corrida",
          "correct": false,
          "feedback": "Elei√ß√µes simult√¢neas s√£o esperadas em sistemas distribu√≠dos ‚Äî √© por isso que protocolos como Raft usam timeouts de elei√ß√£o aleatorizados para reduzir a chance de votos divididos. Mas o verdadeiro problema √© que os n√≥s aceitaram lideran√ßa com apenas 2/5 votos ao inv√©s de exigir a maioria (3/5)."
        },
        {
          "id": "rc-4",
          "text": "A rede entre o N√≥ 1 e o N√≥ 2 est√° particionada, ent√£o eles n√£o conseguem ver a reivindica√ß√£o de lideran√ßa um do outro",
          "correct": false,
          "feedback": "Os logs mostram que ambos os n√≥s est√£o cientes da reivindica√ß√£o de lideran√ßa um do outro (eles registram alertas sobre isso). Os n√≥s conseguem se comunicar ‚Äî eles apenas n√£o possuem uma regra impedindo m√∫ltiplos l√≠deres. A solu√ß√£o √© exigir qu√≥rum de maioria, que matematicamente impede dois l√≠deres."
        }
      ]
    },
    "fix": {
      "question": "Como o processo de elei√ß√£o de l√≠der deve ser corrigido?",
      "options": [
        {
          "id": "fix-1",
          "text": "Exigir qu√≥rum de maioria estrita (3 de 5 n√≥s) para vencer uma elei√ß√£o, e garantir que cada n√≥ vote apenas uma vez por termo",
          "correct": true,
          "feedback": "Correto! Um qu√≥rum de maioria estrita garante no m√°ximo um l√≠der por termo porque a maioria de um conjunto s√≥ pode se sobrepor ‚Äî n√£o se dividir completamente. Se o N√≥ 1 obtiver 3 votos, n√£o sobram votos suficientes para o N√≥ 2 tamb√©m obter 3. Combinado com a regra de que cada n√≥ vota apenas uma vez por termo, esta √© a base do algoritmo de consenso Raft."
        },
        {
          "id": "fix-2",
          "text": "Usar timestamps para escolher o n√≥ que iniciou a elei√ß√£o primeiro como l√≠der",
          "correct": false,
          "feedback": "A sincroniza√ß√£o de rel√≥gios em sistemas distribu√≠dos n√£o √© confi√°vel ‚Äî n√≥s podem discordar sobre que horas s√£o (isso √© abordado em um caso futuro!). A elei√ß√£o de l√≠der n√£o deve depender de rel√≥gios sincronizados. Vota√ß√£o baseada em qu√≥rum n√£o precisa de rel√≥gios."
        },
        {
          "id": "fix-3",
          "text": "Designar um l√≠der de backup fixo para que n√£o haja necessidade de elei√ß√£o",
          "correct": false,
          "feedback": "Um backup fixo introduz um novo ponto √∫nico de falha ‚Äî o que acontece quando tanto o prim√°rio quanto o backup designado est√£o fora do ar? Elei√ß√µes baseadas em qu√≥rum permitem que qualquer n√≥ se torne l√≠der, proporcionando flexibilidade e toler√¢ncia a falhas."
        },
        {
          "id": "fix-4",
          "text": "Adicionar um atraso ap√≥s a queda do antigo l√≠der antes de permitir o in√≠cio de elei√ß√µes",
          "correct": false,
          "feedback": "Um atraso reduz a chance de elei√ß√µes simult√¢neas mas n√£o previne o problema fundamental ‚Äî m√∫ltiplos l√≠deres por falta de qu√≥rum. Voc√™ ainda precisaria da regra de qu√≥rum. Al√©m disso, atrasos maiores significam indisponibilidades mais longas quando um failover real √© necess√°rio."
        }
      ]
    }
  },
  "conceptId": "leader-election",
  "badge": {
    "name": "Oficial de Elei√ß√£o",
    "icon": "üó≥Ô∏è"
  }
}
