{
  "id": "case-10",
  "number": 10,
  "title": "A Manada em Disparada",
  "subtitle": "Todas as delegacias bombardeiam o banco de dados ao mesmo tempo",
  "brief": {
    "narrative": "Toda manh√£ √†s 06:00, a lista de 'Mais Procurados' da Pol√≠cia de Distributia √© atualizada. A lista fica em cache por 24 horas, permitindo consultas r√°pidas ao longo do dia. Mas √†s 06:00:00 em ponto, o cache expira. Simultaneamente, policiais de todas as delegacias iniciam o turno e consultam a lista de Mais Procurados. Nesta manh√£, 2.400 policiais acessaram o sistema dentro do mesmo segundo. Com o cache vazio, todas as requisi√ß√µes foram direto para o banco de dados. O banco cedeu sob a carga, os tempos de resposta dispararam para 30 segundos, e o cache n√£o conseguiu ser reconstru√≠do porque o banco estava lento demais para responder. Por 8 minutos agonizantes, nenhum policial da cidade conseguiu consultar a lista de Mais Procurados.",
    "symptoms": [
      "O cache da lista de Mais Procurados expirou exatamente √†s 06:00:00 para todas as delegacias simultaneamente",
      "2.400 consultas simult√¢neas ao banco de dados no primeiro segundo (normal: 1-2 consultas)",
      "Tempo de resposta do banco de dados disparou de 50ms para 30 segundos",
      "Cache n√£o consegue ser reconstru√≠do porque as respostas do banco est√£o expirando por timeout"
    ],
    "objective": "Identificar como a expira√ß√£o simult√¢nea do cache causou uma debandada no banco de dados e determinar a melhor estrat√©gia de cache para prevenir isso."
  },
  "diagram": {
    "nodes": [
      {
        "id": "cache-server",
        "type": "server",
        "label": "Cache Server (Redis)",
        "status": "degraded",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Servidor de Cache (Redis)",
          "logs": [
            "[06:00:00] INFO: Cache key 'most_wanted_list' EXPIRED (TTL: 24h)",
            "[06:00:00] INFO: CACHE MISS ‚Äî most_wanted_list",
            "[06:00:00] INFO: CACHE MISS x 2,400 in 1 second",
            "[06:00:01] WARN: All 2,400 requests forwarded to database",
            "[06:00:05] WARN: Waiting for database response to rebuild cache",
            "[06:00:35] ERROR: Database response timeout ‚Äî cache not rebuilt",
            "[06:00:36] INFO: Next wave of requests ‚Äî still no cache ‚Äî forwarding to database again"
          ],
          "data": {
            "Cache Key": "most_wanted_list",
            "Status": "EMPTY (expired at 06:00:00)",
            "Cache Hit Rate (last 5 min)": "0%",
            "Requests Forwarded to DB": "2,400/sec",
            "Normal Forwarded Rate": "1 every 24 hours",
            "Cache Rebuild Status": "WAITING (DB too slow to respond)"
          },
          "status": "Cache vazio. Todas as requisi√ß√µes resultam em miss e s√£o encaminhadas ao banco de dados. N√£o √© poss√≠vel reconstruir at√© o banco responder."
        }
      },
      {
        "id": "database",
        "type": "database",
        "label": "Records Database",
        "status": "failed",
        "position": { "x": 350, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Banco de Dados Central de Registros",
          "logs": [
            "[05:59:59] INFO: Normal operations ‚Äî 50 queries/sec, 50ms avg response",
            "[06:00:01] WARN: Query rate spike: 2,400 queries/sec",
            "[06:00:02] ERROR: Connection pool exhausted (max: 200)",
            "[06:00:03] ERROR: Active queries: 200, queued: 2,200",
            "[06:00:10] ERROR: Response time: 15,000ms",
            "[06:00:30] ERROR: Response time: 30,000ms ‚Äî queries timing out",
            "[06:00:35] WARN: Queries from cache rebuild also timing out"
          ],
          "data": {
            "Normal Query Rate": "50/sec",
            "Current Query Rate": "2,400/sec (48x normal)",
            "Connection Pool": "200 / 200 (EXHAUSTED)",
            "Query Queue": "2,200 waiting",
            "Response Time": "30,000ms (normal: 50ms)",
            "CPU": "100%",
            "Status": "OVERWHELMED"
          },
          "status": "Banco de dados sobrecarregado por 2.400 consultas simult√¢neas. Pool de conex√µes esgotado, consultas expirando por timeout."
        }
      },
      {
        "id": "precinct-officers",
        "type": "client",
        "label": "Patrol Officers (2,400)",
        "status": "failed",
        "position": { "x": 100, "y": 150 },
        "inspectable": true,
        "inspectData": {
          "title": "Terminais M√≥veis dos Policiais",
          "logs": [
            "[06:00:00] INFO: Shift start ‚Äî requesting Most Wanted list",
            "[06:00:00] INFO: 2,400 officers requesting simultaneously",
            "[06:00:05] WARN: Loading... (no response yet)",
            "[06:00:30] ERROR: Request timeout ‚Äî Most Wanted list unavailable",
            "[06:00:31] INFO: Retrying request...",
            "[06:00:31] WARN: Retry adds more load to already overwhelmed system"
          ],
          "data": {
            "Officers on Shift": "2,400",
            "Request Time": "06:00:00 (shift start)",
            "Status": "TIMEOUT ‚Äî cannot load Most Wanted list",
            "Retry Behavior": "Automatic retry every 30 seconds",
            "Impact": "Officers patrolling without Most Wanted information"
          },
          "status": "Todos os policiais em patrulha sem conseguir acessar a lista de Mais Procurados no in√≠cio do turno."
        }
      },
      {
        "id": "admin-terminal",
        "type": "client",
        "label": "Admin Terminal",
        "status": "degraded",
        "position": { "x": 600, "y": 150 },
        "inspectable": true,
        "inspectData": {
          "title": "Sistemas Administrativos",
          "logs": [
            "[06:00:05] WARN: Database response times affecting all queries",
            "[06:00:10] ERROR: Routine admin queries timing out due to DB overload",
            "[06:00:15] WARN: Database stampede from cache miss affecting entire system"
          ],
          "data": {
            "Normal Response Time": "100ms",
            "Current Response Time": "TIMEOUT",
            "Impact": "All database-dependent systems affected, not just Most Wanted"
          },
          "status": "Dano colateral ‚Äî a sobrecarga do banco de dados causada pela debandada do cache afeta todos os sistemas."
        }
      }
    ],
    "edges": [
      { "id": "e-officers-cache", "source": "precinct-officers", "target": "cache-server", "label": "2,400 requests", "animated": true, "style": "slow" },
      { "id": "e-cache-db", "source": "cache-server", "target": "database", "label": "cache miss ‚Üí DB", "animated": true, "style": "broken" },
      { "id": "e-admin-db", "source": "admin-terminal", "target": "database", "label": "queries", "animated": true, "style": "slow" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "O que causou a sobrecarga do banco de dados exatamente √†s 06:00?",
      "options": [
        {
          "id": "rc-1",
          "text": "O hardware do banco de dados √© muito lento para lidar com as consultas normais feitas no in√≠cio do turno",
          "correct": false,
          "feedback": "O banco de dados processa 50 consultas/seg com tempo de resposta de 50ms em condi√ß√µes normais ‚Äî √© perfeitamente capaz. O problema √© que 2.400 consultas chegam em 1 segundo (48x a taxa normal) porque o cache expirou para todos simultaneamente. Em opera√ß√£o normal de cache, o banco recebe apenas 1 consulta a cada 24 horas para esses dados."
        },
        {
          "id": "rc-2",
          "text": "Uma debandada de cache ‚Äî o cache expirou simultaneamente para todos os usu√°rios, causando milhares de requisi√ß√µes simult√¢neas ao banco de dados no mesmo instante",
          "correct": true,
          "feedback": "Correto! Isso √© uma debandada de cache (tamb√©m chamada de thundering herd). Quando uma entrada popular do cache expira, todas as requisi√ß√µes simult√¢neas encontram o cache vazio e v√£o direto ao banco de dados. O banco √© projetado para lidar com 50 consultas/seg, mas recebe 2.400 em um segundo. Ele fica t√£o sobrecarregado que n√£o consegue nem responder √† √∫nica consulta necess√°ria para reconstruir o cache, criando um ciclo vicioso."
        },
        {
          "id": "rc-3",
          "text": "O servidor de cache sofreu uma falha e perdeu permanentemente todos os dados armazenados em mem√≥ria",
          "correct": false,
          "feedback": "O servidor de cache est√° funcionando corretamente ‚Äî ele n√£o caiu. A entrada do cache expirou legitimamente ap√≥s seu TTL de 24 horas. O cache est√° funcionando conforme configurado; o problema √© que o padr√£o de expira√ß√£o do TTL causa uma debandada."
        },
        {
          "id": "rc-4",
          "text": "Muitos policiais iniciando simultaneamente seus turnos √†s 06:00 sobrecarregando o sistema de consultas",
          "correct": false,
          "feedback": "Policiais iniciando turnos √†s 06:00 √© normal e esperado. Com cache funcionando corretamente, a primeira requisi√ß√£o reconstr√≥i o cache e as outras 2.399 s√£o atendidas pelo cache em microssegundos. O problema √© que o cache expira justamente quando a demanda √© mais alta, fazendo todas as requisi√ß√µes ignorarem o cache."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor estrat√©gia para prevenir uma debandada de cache?",
      "options": [
        {
          "id": "fix-1",
          "text": "Aumentar o pool de conex√µes do banco de dados para suportar 2.400 consultas simult√¢neas durante picos",
          "correct": false,
          "feedback": "Mais conex√µes n√£o ajudam se a CPU do banco de dados n√£o consegue processar a carga. E voc√™ estaria otimizando para um caso patol√≥gico que nunca deveria acontecer com cache adequado. O objetivo √© prevenir a debandada, n√£o sobreviver a ela."
        },
        {
          "id": "fix-2",
          "text": "Usar cache lock (mutex) para que apenas uma requisi√ß√£o reconstrua o cache enquanto as outras aguardam, combinado com TTLs escalonados (jitter) para evitar expira√ß√£o simult√¢nea",
          "correct": true,
          "feedback": "Correto! Duas t√©cnicas complementares resolvem isso: (1) Cache lock / coalesc√™ncia de requisi√ß√µes: Quando o cache est√° vazio, apenas UMA requisi√ß√£o √© enviada ao banco de dados para reconstruir o cache. Todas as outras requisi√ß√µes aguardam a conclus√£o dessa reconstru√ß√£o e s√£o atendidas pelo cache atualizado. Isso transforma 2.400 consultas ao banco em 1. (2) Jitter no TTL: Adicionar varia√ß√£o aleat√≥ria nos tempos de expira√ß√£o do cache para que as entradas n√£o expirem todas no mesmo instante. Juntas, essas t√©cnicas eliminam completamente o padr√£o de debandada."
        },
        {
          "id": "fix-3",
          "text": "Nunca expirar o cache ‚Äî manter a lista de Mais Procurados em cache permanentemente, sem TTL definido",
          "correct": false,
          "feedback": "Uma lista com cache infinito ficaria desatualizada ‚Äî novos suspeitos nunca apareceriam e suspeitos liberados continuariam listados. Voc√™ precisa da expira√ß√£o do cache para garantir a atualiza√ß√£o dos dados. A solu√ß√£o √© gerenciar COMO o cache √© atualizado, n√£o evitar a atualiza√ß√£o por completo."
        },
        {
          "id": "fix-4",
          "text": "Pr√©-aquecer o cache √†s 05:59 executando a consulta antes do cache antigo expirar automaticamente",
          "correct": false,
          "feedback": "O pr√©-aquecimento ajuda para este caso espec√≠fico, mas n√£o resolve o problema geral. E quanto a outros dados em cache com padr√µes de acesso imprevis√≠veis? Cache lock e jitter no TTL s√£o solu√ß√µes de prop√≥sito geral que funcionam para qualquer dado em cache, n√£o apenas para atualiza√ß√µes programadas."
        }
      ]
    }
  },
  "conceptId": "cache-stampede",
  "badge": {
    "name": "Domador de Debandada",
    "icon": "üêÇ"
  }
}
