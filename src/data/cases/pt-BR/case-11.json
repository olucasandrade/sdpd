{
  "id": "case-11",
  "number": 11,
  "title": "A Parti√ß√£o Quente",
  "subtitle": "Um shard afoga enquanto os outros ficam ociosos",
  "brief": {
    "narrative": "O sistema de registro de crimes da Pol√≠cia de Distributia usa sharding no banco de dados para distribuir registros entre quatro shards. Os registros s√£o particionados pela primeira letra do sobrenome do suspeito: A-F vai para o Shard 1, G-L para o Shard 2, M-R para o Shard 3 e S-Z para o Shard 4. Parecia uma divis√£o justa ‚Äî at√© a temporada de crimes de celebridades chegar. Um esc√¢ndalo envolvendo a rica fam√≠lia Sterling, a popstar Simone Silva, o magnata da tecnologia Sam Stratton e a socialite Sophie St. James gerou 50.000 registros de crimes em uma semana. Todos ca√≠ram no Shard 4 (S-Z). Esse shard est√° a 100% da capacidade enquanto os outros tr√™s est√£o a 15% de utiliza√ß√£o. Os tempos de resposta para qualquer consulta de nomes S-Z agora s√£o de 45 segundos. O sistema est√° efetivamente quebrado para um quarto do alfabeto.",
    "symptoms": [
      "Shard 4 (S-Z) a 100% de CPU e armazenamento, tempo de resposta de 45 segundos",
      "Shards 1-3 a 10-15% de utiliza√ß√£o com tempos de resposta abaixo de 50ms",
      "Todos os registros de crimes de celebridades envolvem suspeitos com sobrenomes come√ßando em S",
      "Policiais n√£o conseguem registrar ou consultar nenhum registro S-Z"
    ],
    "objective": "Identificar como a estrat√©gia de sharding criou uma parti√ß√£o quente e determinar uma abordagem melhor de distribui√ß√£o de dados."
  },
  "diagram": {
    "nodes": [
      {
        "id": "shard-1",
        "type": "database",
        "label": "Shard 1 (A-F)",
        "status": "healthy",
        "position": { "x": 80, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Shard 1 do Banco de Dados (A-F)",
          "logs": [
            "[09:00:00] INFO: Normal operations",
            "[09:15:00] INFO: Query rate: 12/sec, response time: 30ms"
          ],
          "data": {
            "Range": "A-F surnames",
            "Records": "180,000",
            "CPU": "12%",
            "Storage": "15%",
            "Response Time": "30ms",
            "Status": "IDLE ‚Äî significantly underutilized"
          },
          "status": "Saud√°vel e subutilizado. Carga m√≠nima da faixa de sobrenomes A-F."
        }
      },
      {
        "id": "shard-2",
        "type": "database",
        "label": "Shard 2 (G-L)",
        "status": "healthy",
        "position": { "x": 280, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Shard 2 do Banco de Dados (G-L)",
          "logs": [
            "[09:00:00] INFO: Normal operations",
            "[09:15:00] INFO: Query rate: 15/sec, response time: 35ms"
          ],
          "data": {
            "Range": "G-L surnames",
            "Records": "195,000",
            "CPU": "14%",
            "Storage": "16%",
            "Response Time": "35ms",
            "Status": "IDLE ‚Äî significantly underutilized"
          },
          "status": "Saud√°vel e subutilizado."
        }
      },
      {
        "id": "shard-3",
        "type": "database",
        "label": "Shard 3 (M-R)",
        "status": "healthy",
        "position": { "x": 480, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Shard 3 do Banco de Dados (M-R)",
          "logs": [
            "[09:00:00] INFO: Normal operations",
            "[09:15:00] INFO: Query rate: 18/sec, response time: 40ms"
          ],
          "data": {
            "Range": "M-R surnames",
            "Records": "210,000",
            "CPU": "15%",
            "Storage": "17%",
            "Response Time": "40ms",
            "Status": "IDLE ‚Äî significantly underutilized"
          },
          "status": "Saud√°vel e subutilizado."
        }
      },
      {
        "id": "shard-4",
        "type": "database",
        "label": "Shard 4 (S-Z)",
        "status": "failed",
        "position": { "x": 680, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Shard 4 do Banco de Dados (S-Z) ‚Äî PARTI√á√ÉO QUENTE",
          "logs": [
            "[09:00:00] WARN: Record count growing rapidly ‚Äî celebrity crime wave",
            "[09:05:00] WARN: CPU: 78%, climbing fast",
            "[09:10:00] ERROR: CPU: 95%, response time: 12,000ms",
            "[09:12:00] ERROR: Storage: 98% ‚Äî approaching disk full",
            "[09:14:00] ERROR: CPU: 100%, connection pool exhausted",
            "[09:15:00] ERROR: Response time: 45,000ms ‚Äî effectively unresponsive",
            "[09:15:01] ERROR: 50,000 celebrity crime reports all on this shard"
          ],
          "data": {
            "Range": "S-Z surnames",
            "Records": "460,000 (2.5x other shards)",
            "Celebrity Reports (this week)": "50,000",
            "CPU": "100%",
            "Storage": "98%",
            "Response Time": "45,000ms",
            "Connection Pool": "500/500 (EXHAUSTED)",
            "Status": "HOT PARTITION ‚Äî overwhelmed"
          },
          "status": "Parti√ß√£o quente. Todos os registros de crimes de celebridades (sobrenomes com S) concentrados neste shard."
        }
      },
      {
        "id": "router",
        "type": "server",
        "label": "Shard Router",
        "status": "healthy",
        "position": { "x": 380, "y": 280 },
        "inspectable": true,
        "inspectData": {
          "title": "Roteador de Shards do Banco de Dados",
          "logs": [
            "[09:00:00] INFO: Routing by first letter of suspect surname",
            "[09:10:00] WARN: 89% of traffic routed to Shard 4 (S-Z)",
            "[09:12:00] WARN: Shards 1-3 receiving 3-5% traffic each",
            "[09:14:00] ERROR: Shard 4 responses timing out ‚Äî cannot reroute (fixed partitioning)"
          ],
          "data": {
            "Routing Strategy": "First letter of surname ‚Üí shard",
            "Traffic Distribution": "Shard 1: 3%, Shard 2: 4%, Shard 3: 4%, Shard 4: 89%",
            "Can Rebalance": "NO ‚Äî fixed range partitioning",
            "Rerouting Available": "NO ‚Äî data is physically on Shard 4"
          },
          "status": "O roteador est√° funcionando corretamente conforme suas regras, mas as regras criam uma parti√ß√£o quente. N√£o √© poss√≠vel rebalancear."
        }
      }
    ],
    "edges": [
      { "id": "e-router-s1", "source": "router", "target": "shard-1", "label": "3% traffic", "animated": true, "style": "normal" },
      { "id": "e-router-s2", "source": "router", "target": "shard-2", "label": "4% traffic", "animated": true, "style": "normal" },
      { "id": "e-router-s3", "source": "router", "target": "shard-3", "label": "4% traffic", "animated": true, "style": "normal" },
      { "id": "e-router-s4", "source": "router", "target": "shard-4", "label": "89% traffic", "animated": true, "style": "broken" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz da sobrecarga do Shard 4?",
      "options": [
        {
          "id": "rc-1",
          "text": "O hardware do Shard 4 √© mais fraco e menos capaz do que o hardware dos outros tr√™s shards do cluster",
          "correct": false,
          "feedback": "Todos os shards t√™m hardware id√™ntico. O problema √© que o Shard 4 recebe tr√°fego desproporcional porque a estrat√©gia de particionamento (primeira letra do sobrenome) n√£o distribui os dados uniformemente. Quando um evento em alta envolve suspeitos cujos nomes se concentram em uma faixa (S-Z), esse shard se torna uma parti√ß√£o quente."
        },
        {
          "id": "rc-2",
          "text": "O particionamento por faixas cria parti√ß√µes quentes pois os acessos n√£o s√£o distribu√≠dos uniformemente",
          "correct": true,
          "feedback": "Correto! O particionamento por faixa de chaves (A-F, G-L, M-R, S-Z) assume que os dados e padr√µes de acesso s√£o distribu√≠dos uniformemente pelo alfabeto. Mas dados do mundo real n√£o s√£o uniformes ‚Äî distribui√ß√µes de sobrenomes variam por cultura, e eventos em alta podem concentrar tr√°fego em faixas de chaves espec√≠ficas. Quando a onda de crimes de celebridades atingiu sobrenomes com S, o Shard 4 se tornou uma 'parti√ß√£o quente' recebendo 89% de todo o tr√°fego enquanto os outros ficavam ociosos. Este √© o risco fundamental do particionamento baseado em faixa."
        },
        {
          "id": "rc-3",
          "text": "H√° registros de crimes de celebridades em grande quantidade demais ‚Äî o sistema n√£o foi projetado para tal volume",
          "correct": false,
          "feedback": "O volume total (50.000 registros) √© gerenci√°vel ‚Äî distribu√≠do entre os quatro shards, cada um lidaria com apenas 12.500 registros extras, bem dentro da capacidade. O problema √© a concentra√ß√£o, n√£o o volume. Todos os 50.000 registros caem em UM shard por causa da estrat√©gia de particionamento."
        },
        {
          "id": "rc-4",
          "text": "O roteador de shards tem um bug no algoritmo que envia volume de tr√°fego excessivo para o Shard 4",
          "correct": false,
          "feedback": "O roteador est√° funcionando exatamente como projetado ‚Äî ele corretamente direciona sobrenomes S-Z para o Shard 4. O problema est√° na estrat√©gia de particionamento em si, n√£o na implementa√ß√£o do roteador. Uma estrat√©gia ruim implementada corretamente continua sendo uma estrat√©gia ruim."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor estrat√©gia de particionamento para evitar parti√ß√µes quentes?",
      "options": [
        {
          "id": "fix-1",
          "text": "Usar particionamento baseado em hash ‚Äî aplicar hash na chave do registro e distribuir com base no valor do hash, garantindo distribui√ß√£o uniforme independente dos padr√µes de dados",
          "correct": true,
          "feedback": "Correto! O particionamento baseado em hash aplica uma fun√ß√£o de hash (como MD5 ou SHA-256) √† chave de parti√ß√£o e atribui registros aos shards com base no valor do hash. Como fun√ß√µes de hash distribuem as sa√≠das uniformemente, mesmo que todos os suspeitos tenham sobrenomes com S, seus valores de hash ser√£o distribu√≠dos igualmente entre todos os shards. 'Sterling' pode ir para o Shard 2, 'Silva' para o Shard 1, etc. A contrapartida √© que voc√™ perde a capacidade de fazer consultas de faixa eficientes (como 'todos os sobrenomes come√ßando com S'), mas ganha distribui√ß√£o uniforme. Consistent hashing melhora ainda mais isso, facilitando adicionar/remover shards."
        },
        {
          "id": "fix-2",
          "text": "Adicionar mais shards dedica√ß√£o √† faixa S-Z para dividir a carga de forma manual entre mais parti√ß√µes",
          "correct": false,
          "feedback": "Dividir S-Z em mais sub-faixas (S-T, U-V, W-Z) ajuda temporariamente, mas n√£o resolve o problema fundamental. Uma futura onda de crimes de celebridades poderia concentrar-se em qualquer sub-faixa. O particionamento baseado em hash distribui dados uniformemente independente dos valores das chaves."
        },
        {
          "id": "fix-3",
          "text": "Rebalancear as faixas manualmente para que cada shard tenha registros iguais (ex.: mover letra S para o Shard 3)",
          "correct": false,
          "feedback": "Rebalancear com base nos dados atuais ajuda agora, mas exige ajuste manual constante conforme os padr√µes de dados mudam. O assunto em alta de amanh√£ pode sobrecarregar as faixas rec√©m-rebalanceadas. O particionamento baseado em hash fornece distribui√ß√£o uniforme autom√°tica sem interven√ß√£o manual."
        },
        {
          "id": "fix-4",
          "text": "Usar distribui√ß√£o round-robin ‚Äî atribuir cada novo registro ao pr√≥ximo shard dispon√≠vel na sequ√™ncia",
          "correct": false,
          "feedback": "Round-robin distribui escritas uniformemente, mas torna consultas imposs√≠veis sem consultar todos os shards (voc√™ n√£o sabe qual shard tem um determinado registro). O particionamento baseado em hash distribui uniformemente E permite consultas diretas ‚Äî basta calcular o hash para saber exatamente qual shard consultar."
        }
      ]
    }
  },
  "conceptId": "data-partitioning",
  "badge": {
    "name": "Cirurgi√£o de Shards",
    "icon": "üî™"
  }
}
