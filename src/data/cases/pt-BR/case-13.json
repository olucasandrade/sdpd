{
  "id": "case-13",
  "number": 13,
  "title": "A Situa√ß√£o Grudenta",
  "subtitle": "Queda de servidor apaga centenas de sess√µes ativas de policiais",
  "brief": {
    "narrative": "A Pol√≠cia de Distributia recentemente implantou um load balancer para o sistema de despacho ‚Äî tr√™s servidores dividindo a carga. Parecia √≥timo, exceto que configuraram sticky sessions: o navegador de cada policial √© permanentemente vinculado a um servidor espec√≠fico. O Servidor 2 acabou de cair, e 340 policiais que estavam no meio do turno foram deslogados de repente. Suas anota√ß√µes de casos em andamento, relat√≥rios n√£o salvos e designa√ß√µes de despacho ‚Äî tudo perdido. Enquanto isso, os Servidores 1 e 3 est√£o bem, mas n√£o fazem ideia do que aqueles 340 policiais estavam fazendo. Os dados de sess√£o existiam apenas na mem√≥ria do Servidor 2. O Chefe Partition est√° furioso, Detetive.",
    "symptoms": [
      "340 policiais deslogados simultaneamente ap√≥s queda do Servidor 2",
      "Anota√ß√µes de casos em andamento e dados de despacho n√£o salvos perdidos para os policiais afetados",
      "Servidores 1 e 3 operando normalmente, mas n√£o conseguem restaurar as sess√µes perdidas",
      "Policiais precisam fazer login novamente e refazer todo o trabalho em andamento"
    ],
    "objective": "Identificar por que a queda do servidor causou perda de sess√£o para um ter√ßo dos usu√°rios, e recomendar uma arquitetura que desacople as sess√µes de servidores individuais."
  },
  "diagram": {
    "nodes": [
      {
        "id": "load-balancer",
        "type": "server",
        "label": "Load Balancer",
        "status": "healthy",
        "position": { "x": 350, "y": 30 },
        "inspectable": true,
        "inspectData": {
          "title": "Load Balancer (Sticky Sessions)",
          "logs": [
            "[14:30:00] INFO: Sticky session routing enabled",
            "[14:45:12] ERROR: Server 2 health check failed",
            "[14:45:13] WARN: 340 sticky sessions orphaned ‚Äî no failover for session state",
            "[14:45:14] INFO: New requests routed to Server 1 and Server 3"
          ],
          "data": {
            "Mode": "Sticky Sessions (cookie-based)",
            "Server 1 Sessions": "310 (active)",
            "Server 2 Sessions": "340 (LOST)",
            "Server 3 Sessions": "295 (active)",
            "Session Failover": "None ‚Äî state is server-local"
          },
          "status": "Sticky sessions habilitadas. Nenhum armazenamento compartilhado de sess√µes configurado."
        }
      },
      {
        "id": "server-1",
        "type": "server",
        "label": "Dispatch Server 1",
        "status": "healthy",
        "position": { "x": 100, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "Servidor de Despacho 1",
          "logs": [
            "[14:45:15] INFO: Operating normally",
            "[14:45:20] INFO: Receiving redirected traffic from LB"
          ],
          "data": {
            "Status": "HEALTHY",
            "Local Sessions": "310",
            "Memory Session Store": "In-process only"
          },
          "status": "Saud√°vel, mas sess√µes armazenadas apenas na mem√≥ria local."
        }
      },
      {
        "id": "server-2",
        "type": "server",
        "label": "Dispatch Server 2",
        "status": "failed",
        "position": { "x": 350, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "Servidor de Despacho 2",
          "logs": [
            "[14:44:58] ERROR: Out of memory ‚Äî process killed",
            "[14:44:59] FATAL: Server process terminated",
            "[14:45:00] INFO: 340 in-memory sessions destroyed"
          ],
          "data": {
            "Status": "CRASHED",
            "Local Sessions": "0 (all lost)",
            "Crash Reason": "OOM kill"
          },
          "status": "Caiu. Todas as 340 sess√µes armazenadas localmente perdidas permanentemente."
        }
      },
      {
        "id": "server-3",
        "type": "server",
        "label": "Dispatch Server 3",
        "status": "healthy",
        "position": { "x": 600, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "Servidor de Despacho 3",
          "logs": [
            "[14:45:15] INFO: Operating normally",
            "[14:45:22] INFO: Receiving redirected traffic from LB"
          ],
          "data": {
            "Status": "HEALTHY",
            "Local Sessions": "295",
            "Memory Session Store": "In-process only"
          },
          "status": "Saud√°vel, mas sess√µes armazenadas apenas na mem√≥ria local."
        }
      },
      {
        "id": "officers",
        "type": "client",
        "label": "Officer Terminals",
        "status": "degraded",
        "position": { "x": 350, "y": 380 },
        "inspectable": true,
        "inspectData": {
          "title": "Terminais dos Policiais",
          "logs": [
            "[14:45:13] ERROR: 340 terminals received 'Session Expired'",
            "[14:45:30] WARN: Officers reporting lost case notes and dispatch data"
          ],
          "data": {
            "Total Officers Online": "945",
            "Sessions Lost": "340",
            "Unsaved Reports Lost": "~127"
          },
          "status": "340 policiais perderam todo o estado da sess√£o e precisam fazer login novamente."
        }
      }
    ],
    "edges": [
      { "id": "e-lb-s1", "source": "load-balancer", "target": "server-1", "label": "sticky route", "animated": true, "style": "normal" },
      { "id": "e-lb-s2", "source": "load-balancer", "target": "server-2", "label": "sticky route", "animated": false, "style": "broken" },
      { "id": "e-lb-s3", "source": "load-balancer", "target": "server-3", "label": "sticky route", "animated": true, "style": "normal" },
      { "id": "e-officers-lb", "source": "officers", "target": "load-balancer", "label": "requests", "animated": true, "style": "normal" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz de 340 policiais perderem suas sess√µes?",
      "options": [
        {
          "id": "rc-1",
          "text": "O load balancer falhou em redistribuir as sess√µes para servidores saud√°veis ap√≥s a queda",
          "correct": false,
          "feedback": "O load balancer redirecionou novas requisi√ß√µes, mas os dados de sess√£o existiam apenas na mem√≥ria do Servidor 2. N√£o h√° nada para redistribuir ‚Äî os dados se foram. O problema √© onde as sess√µes s√£o armazenadas, n√£o como o tr√°fego √© roteado."
        },
        {
          "id": "rc-2",
          "text": "Sticky sessions vincularam o estado do usu√°rio a um servidor espec√≠fico ‚Äî quando aquele servidor morreu, o estado morreu com ele",
          "correct": true,
          "feedback": "Correto! Sticky sessions vinculam usu√°rios a servidores espec√≠ficos e armazenam o estado da sess√£o na mem√≥ria local daquele servidor. Isso cria um servi√ßo com estado (stateful) ‚Äî se o servidor cai, todos os dados de sess√£o s√£o perdidos. Servi√ßos sem estado (stateless) armazenam dados de sess√£o externamente para que qualquer servidor possa atender qualquer requisi√ß√£o."
        },
        {
          "id": "rc-3",
          "text": "O Servidor 2 ficou sem mem√≥ria porque estava lidando com sess√µes demais comparado aos outros",
          "correct": false,
          "feedback": "Embora o OOM kill tenha disparado a queda, o verdadeiro problema arquitetural √© que sess√µes s√£o armazenadas na mem√≥ria do servidor. Mesmo com sess√µes perfeitamente balanceadas, qualquer queda de servidor destruiria todas as sess√µes armazenadas localmente."
        },
        {
          "id": "rc-4",
          "text": "Os servidores n√£o tinham um mecanismo adequado de backup e recupera√ß√£o para dados de sess√£o",
          "correct": false,
          "feedback": "Fazer backup de sess√µes em mem√≥ria √© impratic√°vel e n√£o resolve o problema central. O problema √© o padr√£o de design com estado (stateful) ‚Äî sess√µes devem ser externalizadas para que os servidores n√£o guardem estado cr√≠tico em primeiro lugar."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor solu√ß√£o para prevenir perda de sess√£o quando um servidor cai?",
      "options": [
        {
          "id": "fix-1",
          "text": "Adicionar mais servidores para que cada um lide com menos sess√µes, reduzindo o impacto de uma queda",
          "correct": false,
          "feedback": "Mais servidores com sticky sessions apenas significa que cada queda afeta menos usu√°rios ‚Äî mas quedas ainda destroem sess√µes. O problema n√£o √© quantos servidores voc√™ tem; √© que o estado da sess√£o vive dentro de servidores individuais."
        },
        {
          "id": "fix-2",
          "text": "Tornar os servi√ßos stateless armazenando sess√µes em um store externo compartilhado (ex.: Redis) para que qualquer servidor possa atender qualquer requisi√ß√£o",
          "correct": true,
          "feedback": "Correto! Ao externalizar o estado da sess√£o para um store compartilhado como Redis, os servidores se tornam stateless e intercambi√°veis. Qualquer servidor pode atender a requisi√ß√£o de qualquer usu√°rio, sticky sessions se tornam desnecess√°rias, e uma queda de servidor n√£o perde nenhum dado de sess√£o."
        },
        {
          "id": "fix-3",
          "text": "Replicar dados de sess√£o entre os tr√™s servidores em tempo real",
          "correct": false,
          "feedback": "Replica√ß√£o de sess√£o entre servidores √© complexa e cara. N√£o escala bem ‚Äî cada novo servidor aumenta o tr√°fego de replica√ß√£o. Um store externo de sess√µes √© mais simples e escal√°vel."
        },
        {
          "id": "fix-4",
          "text": "Implementar rein√≠cio autom√°tico de servidor para que servidores que ca√≠ram voltem rapidamente",
          "correct": false,
          "feedback": "Rein√≠cios r√°pidos ajudam a disponibilidade, mas sess√µes em mem√≥ria ainda s√£o perdidas quando um processo morre. O servidor volta vazio. A verdadeira solu√ß√£o √© n√£o armazenar sess√µes na mem√≥ria do servidor."
        }
      ]
    }
  },
  "conceptId": "stateless-services",
  "badge": {
    "name": "Libertador de Estado",
    "icon": "üîì"
  }
}
