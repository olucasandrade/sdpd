{
  "id": "case-14",
  "number": 14,
  "title": "O Registro Fantasma",
  "subtitle": "Um registro criminal deletado continua assombrando o sistema",
  "brief": {
    "narrative": "Um caso de grande repercuss√£o acabou de ser anulado pelo tribunal ‚Äî e a culpa √© da Pol√≠cia de Distributia. Tr√™s semanas atr√°s, o registro criminal de um suspeito foi oficialmente apagado por ordem judicial. A equipe do banco de dados confirmou a exclus√£o do banco de registros principal. Mas policiais em campo ainda veem o registro quando fazem consultas. O suspeito foi parado ontem, o policial viu 'crime anterior' na tela e escalou a abordagem desnecessariamente. O advogado do suspeito est√° entrando com uma queixa de viola√ß√£o de direitos civis. Como um registro deletado ainda est√° aparecendo? O Chefe Partition precisa de respostas antes da coletiva de imprensa, Detetive.",
    "symptoms": [
      "Registro criminal apagado ainda aparece nas consultas dos policiais",
      "Banco de dados confirma que o registro foi deletado h√° 3 semanas",
      "M√∫ltiplas delegacias reportam ver o registro fantasma",
      "Cache mostra TTL de 30 dias ‚Äî registro n√£o vai expirar naturalmente por mais 9 dias"
    ],
    "objective": "Identificar por que um registro deletado do banco de dados ainda est√° sendo exibido para os usu√°rios, e recomendar uma estrat√©gia adequada de invalida√ß√£o de cache."
  },
  "diagram": {
    "nodes": [
      {
        "id": "records-db",
        "type": "database",
        "label": "Records Database",
        "status": "healthy",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Banco de Dados de Registros Criminais",
          "logs": [
            "[3 weeks ago] INFO: DELETE record #CR-8847 executed (court order #2024-1192)",
            "[3 weeks ago] INFO: Record #CR-8847 confirmed removed from all tables",
            "[Today] INFO: Query for #CR-8847 returns: NO RECORD FOUND"
          ],
          "data": {
            "Status": "HEALTHY",
            "Record #CR-8847": "DELETED (3 weeks ago)",
            "Deletion Confirmed": "Yes ‚Äî court order #2024-1192"
          },
          "status": "Banco de dados est√° correto. Registro foi devidamente deletado."
        }
      },
      {
        "id": "cache-layer",
        "type": "server",
        "label": "Redis Cache",
        "status": "degraded",
        "position": { "x": 350, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "Camada de Cache Redis",
          "logs": [
            "[3 weeks ago] INFO: Cache entry for #CR-8847 created with TTL 30d",
            "[Today] INFO: Cache HIT for #CR-8847 ‚Äî serving cached data",
            "[Today] WARN: No cache invalidation triggered on record deletion",
            "[Today] INFO: TTL remaining for #CR-8847: 9 days"
          ],
          "data": {
            "Status": "SERVING STALE DATA",
            "Cache Key": "record:CR-8847",
            "Cached Value": "{name: 'J. Doe', priors: 'felony', status: 'active'}",
            "TTL Remaining": "9 days",
            "Invalidation Policy": "None ‚Äî TTL expiry only"
          },
          "status": "Cache ainda cont√©m o registro deletado. Nenhuma invalida√ß√£o foi acionada na exclus√£o."
        }
      },
      {
        "id": "api-server",
        "type": "server",
        "label": "Lookup API",
        "status": "healthy",
        "position": { "x": 100, "y": 350 },
        "inspectable": true,
        "inspectData": {
          "title": "API de Consulta de Registros",
          "logs": [
            "[Today 09:15:00] INFO: Lookup request for #CR-8847",
            "[Today 09:15:00] INFO: Cache HIT ‚Äî returning cached result",
            "[Today 09:15:00] INFO: Database NOT queried (cache served response)"
          ],
          "data": {
            "Cache Hit Rate": "94%",
            "DB Queries Bypassed": "94% of lookups",
            "Invalidation on Write": "NOT CONFIGURED"
          },
          "status": "API serve dados do cache sem verificar se o registro de origem ainda existe."
        }
      },
      {
        "id": "officer-terminal",
        "type": "client",
        "label": "Officer MDT",
        "status": "degraded",
        "position": { "x": 550, "y": 350 },
        "inspectable": true,
        "inspectData": {
          "title": "Terminal M√≥vel de Dados",
          "logs": [
            "[Today 09:15:01] INFO: Record lookup for suspect returned: PRIOR FELONY",
            "[Today 09:15:02] WARN: Officer escalated stop based on displayed record"
          ],
          "data": {
            "Displayed Record": "Prior felony ‚Äî ACTIVE",
            "Actual Record": "EXPUNGED (deleted 3 weeks ago)",
            "Data Source": "Served from cache, not database"
          },
          "status": "Exibindo dados desatualizados do cache que n√£o existem mais no banco de dados."
        }
      }
    ],
    "edges": [
      { "id": "e-cache-db", "source": "cache-layer", "target": "records-db", "label": "read-through", "animated": false, "style": "normal" },
      { "id": "e-api-cache", "source": "api-server", "target": "cache-layer", "label": "cache lookup", "animated": true, "style": "normal" },
      { "id": "e-terminal-api", "source": "officer-terminal", "target": "api-server", "label": "lookup request", "animated": true, "style": "normal" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz do registro deletado ainda aparecer nas consultas?",
      "options": [
        {
          "id": "rc-1",
          "text": "A exclus√£o do banco de dados falhou silenciosamente e o registro ainda existe no sistema",
          "correct": false,
          "feedback": "Os logs do banco de dados confirmam que o registro foi deletado com sucesso ‚Äî consultar o banco diretamente retorna 'NENHUM REGISTRO ENCONTRADO'. Os dados desatualizados est√£o vindo de outro lugar do sistema."
        },
        {
          "id": "rc-2",
          "text": "O cache nunca foi invalidado quando o registro foi deletado ‚Äî est√° servindo dados desatualizados at√© o TTL expirar",
          "correct": true,
          "feedback": "Correto! O cache tem um TTL de 30 dias e nenhuma pol√≠tica de invalida√ß√£o por escrita. Quando o registro foi deletado do banco de dados, ningu√©m avisou o cache. Ele vai continuar servindo o registro fantasma por mais 9 dias. Este √© o cl√°ssico problema de invalida√ß√£o de cache."
        },
        {
          "id": "rc-3",
          "text": "O terminal do policial tem um cache local pr√≥prio que n√£o foi devidamente atualizado ap√≥s a exclus√£o",
          "correct": false,
          "feedback": "O terminal busca dados da API em tempo real. Os dados desatualizados est√£o sendo servidos pela camada de cache Redis, n√£o por um cache local do terminal. O terminal est√° exibindo exatamente o que a API retorna."
        },
        {
          "id": "rc-4",
          "text": "Um atraso na replica√ß√£o do banco de dados est√° impedindo que a exclus√£o seja propagada para todos os n√≥s",
          "correct": false,
          "feedback": "A exclus√£o aconteceu h√° 3 semanas ‚Äî o atraso de replica√ß√£o seria resolvido em segundos ou minutos, n√£o semanas. O pr√≥prio banco de dados mostra corretamente o registro como deletado. O problema est√° na camada de cache."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor solu√ß√£o para evitar que registros fantasmas apare√ßam ap√≥s exclus√£o?",
      "options": [
        {
          "id": "fix-1",
          "text": "Reduzir o TTL do cache de 30 dias para apenas 5 minutos para que dados desatualizados sejam limpos rapidamente",
          "correct": false,
          "feedback": "Um TTL mais curto reduz a janela de dados desatualizados, mas n√£o a elimina. Por 5 minutos ap√≥s qualquer exclus√£o, policiais ainda veriam registros fantasmas. Para registros legalmente apagados, at√© 5 minutos de dados desatualizados √© inaceit√°vel. Invalida√ß√£o ativa √© necess√°ria."
        },
        {
          "id": "fix-2",
          "text": "Implementar invalida√ß√£o de cache na escrita ‚Äî deletar ou atualizar automaticamente entradas do cache quando registros do banco de dados mudam",
          "correct": true,
          "feedback": "Correto! A invalida√ß√£o de cache write-through ou write-behind garante que quando um registro √© deletado (ou atualizado) no banco de dados, a entrada correspondente no cache √© imediatamente invalidada. Assim, a pr√≥xima consulta n√£o encontra no cache, vai ao banco de dados e obt√©m o resultado correto."
        },
        {
          "id": "fix-3",
          "text": "Desabilitar o cache completamente para registros criminais a fim de sempre obter os dados mais recentes",
          "correct": false,
          "feedback": "Desabilitar o cache resolveria o problema de dados desatualizados, mas aumentaria dramaticamente a carga no banco de dados. Com uma taxa de acerto de cache de 94%, remover o cache significa 16x mais consultas ao banco. A abordagem correta √© cache mais inteligente, n√£o aus√™ncia de cache."
        },
        {
          "id": "fix-4",
          "text": "Adicionar um bot√£o manual de 'limpar cache' para administradores usarem imediatamente ap√≥s exclus√µes",
          "correct": false,
          "feedback": "Limpeza manual de cache √© propensa a erros e n√£o escala. Humanos v√£o esquecer. A invalida√ß√£o de cache deve ser automatizada e acionada por opera√ß√µes de escrita no banco de dados, n√£o por processos manuais."
        }
      ]
    }
  },
  "conceptId": "cache-invalidation",
  "badge": {
    "name": "Ca√ßador de Cache",
    "icon": "üëª"
  }
}
