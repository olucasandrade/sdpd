{
  "id": "case-18",
  "number": 18,
  "title": "O Despacho Perdido",
  "subtitle": "Queda do servidor faz todas as chamadas de despacho pendentes desaparecerem da fila",
  "brief": {
    "narrative": "O sistema de despacho da DP de Distributia usa uma fila de mensagens para gerenciar as atribui√ß√µes de patrulha. Quando uma chamada de emerg√™ncia chega, ela √© colocada na fila, e as unidades de patrulha dispon√≠veis pegam as atribui√ß√µes do outro lado. Estava funcionando perfeitamente ‚Äî at√© o servidor da fila cair √†s 3h da manh√£ durante uma sexta-feira movimentada. Quando voltou ao ar 4 minutos depois, a fila estava vazia. Vinte e tr√™s chamadas de despacho que estavam aguardando na fila ‚Äî incluindo dois relatos de assalto √† m√£o armada de alta prioridade ‚Äî simplesmente desapareceram. A fila estava operando inteiramente em mem√≥ria, sem persist√™ncia. Essas chamadas nunca foram despachadas. O Chefe Partition precisa saber por que mensagens cr√≠ticas de despacho podem simplesmente desaparecer, Detetive.",
    "symptoms": [
      "23 mensagens de despacho pendentes perdidas durante queda de 4 minutos do servidor",
      "Servidor da fila reiniciou com a fila vazia ‚Äî sem recupera√ß√£o das mensagens pendentes",
      "Duas chamadas de alta prioridade de assalto √† m√£o armada estavam entre os despachos perdidos",
      "Fila configurada apenas com armazenamento em mem√≥ria ‚Äî sem persist√™ncia em disco"
    ],
    "objective": "Identificar por que a fila de mensagens perdeu todas as mensagens pendentes durante a queda e recomendar uma estrat√©gia de durabilidade."
  },
  "diagram": {
    "nodes": [
      {
        "id": "dispatch-intake",
        "type": "server",
        "label": "911 Dispatch Intake",
        "status": "healthy",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Sistema de Recebimento de Chamadas de Emerg√™ncia",
          "logs": [
            "[03:00:01] INFO: Dispatch call #D-4471 queued (armed robbery)",
            "[03:00:15] INFO: Dispatch call #D-4472 queued (armed robbery)",
            "[03:01:00] INFO: 21 additional calls queued between 03:00-03:04",
            "[03:04:10] WARN: Queue server connection lost ‚Äî calls buffering locally"
          ],
          "data": {
            "Calls Sent to Queue": "23 (between 03:00-03:04)",
            "Acknowledgments Received": "23 (queue accepted them)",
            "Status": "HEALTHY"
          },
          "status": "Sistema de recebimento funcionando. Todas as 23 chamadas foram aceitas pela fila."
        }
      },
      {
        "id": "message-queue",
        "type": "server",
        "label": "Message Queue",
        "status": "failed",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Fila de Mensagens de Despacho",
          "logs": [
            "[03:00:00] INFO: 23 messages in queue (in-memory)",
            "[03:04:05] FATAL: Process crashed ‚Äî out of memory",
            "[03:04:06] INFO: All in-memory data lost",
            "[03:08:10] INFO: Server restarted ‚Äî queue is EMPTY",
            "[03:08:11] WARN: No persistence layer ‚Äî cannot recover messages"
          ],
          "data": {
            "Storage": "In-memory ONLY",
            "Persistence": "DISABLED",
            "Messages Before Crash": "23",
            "Messages After Restart": "0",
            "Write-Ahead Log": "Not configured",
            "Disk Backup": "None"
          },
          "status": "Falhou. Todas as 23 mensagens na fila foram permanentemente perdidas ‚Äî sem persist√™ncia configurada."
        }
      },
      {
        "id": "patrol-units",
        "type": "client",
        "label": "Patrol Units",
        "status": "degraded",
        "position": { "x": 600, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Frota de Unidades de Patrulha",
          "logs": [
            "[03:04:10] WARN: No new dispatches received",
            "[03:08:15] INFO: Queue reconnected ‚Äî but no pending assignments",
            "[03:08:20] WARN: 23 calls never dispatched to any unit"
          ],
          "data": {
            "Available Units": "12",
            "Dispatches Received (03:00-03:08)": "0",
            "Expected Dispatches": "23",
            "Status": "IDLE (waiting for assignments that were lost)"
          },
          "status": "Unidades de patrulha nunca receberam as 23 chamadas de despacho perdidas."
        }
      },
      {
        "id": "callers",
        "type": "client",
        "label": "911 Callers",
        "status": "failed",
        "position": { "x": 350, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Pessoas que Ligaram para Emerg√™ncia",
          "logs": [
            "[03:15:00] WARN: Caller #D-4471 called back ‚Äî no officers arrived",
            "[03:18:00] WARN: Caller #D-4472 called back ‚Äî armed robbery still in progress"
          ],
          "data": {
            "Affected Callers": "23",
            "High Priority Lost": "2 (armed robbery)",
            "Avg Wait Before Callback": "15 minutes"
          },
          "status": "Pessoas aguardando resposta de despachos que nunca foram enviados."
        }
      }
    ],
    "edges": [
      { "id": "e-intake-queue", "source": "dispatch-intake", "target": "message-queue", "label": "enqueue calls", "animated": true, "style": "normal" },
      { "id": "e-queue-patrol", "source": "message-queue", "target": "patrol-units", "label": "dispatch (lost)", "animated": false, "style": "broken" },
      { "id": "e-callers-intake", "source": "callers", "target": "dispatch-intake", "label": "911 calls", "animated": true, "style": "normal" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz da perda das 23 mensagens de despacho?",
      "options": [
        {
          "id": "rc-1",
          "text": "O sistema de recebimento de chamadas falhou ao enviar as mensagens para a fila de despacho corretamente",
          "correct": false,
          "feedback": "O sistema de recebimento enviou com sucesso todas as 23 mensagens e recebeu confirma√ß√µes da fila. As mensagens foram aceitas e armazenadas ‚Äî s√≥ que foram armazenadas apenas em mem√≥ria vol√°til."
        },
        {
          "id": "rc-2",
          "text": "A fila de mensagens armazenava dados apenas em mem√≥ria, sem persist√™ncia ‚Äî quando ela caiu, todas as mensagens pendentes foram permanentemente perdidas",
          "correct": true,
          "feedback": "Correto! A fila n√£o tinha nenhum mecanismo de durabilidade ‚Äî sem write-ahead log, sem persist√™ncia em disco, sem replica√ß√£o. Filas apenas em mem√≥ria s√£o r√°pidas, mas vol√°teis. Quando o processo caiu, a RAM foi limpa e todas as 23 mensagens desapareceram. A durabilidade de mensagens requer persistir as mensagens em disco antes de confirm√°-las."
        },
        {
          "id": "rc-3",
          "text": "As unidades de patrulha consumiram as mensagens da fila, mas falharam ao processadas individualmente",
          "correct": false,
          "feedback": "As unidades de patrulha nunca receberam as mensagens. As mensagens estavam na fila aguardando para serem consumidas quando o servidor caiu. As mensagens foram perdidas antes da entrega, n√£o depois."
        },
        {
          "id": "rc-4",
          "text": "O processo de recupera√ß√£o do servidor da fila tem um bug que limpa automaticamente toda a fila ao reiniciar",
          "correct": false,
          "feedback": "N√£o h√° bug ‚Äî a fila genuinamente n√£o tem nada para recuperar. Com armazenamento apenas em mem√≥ria, n√£o h√° dados em disco para restaurar. A fila vazia ap√≥s o rein√≠cio √© o comportamento esperado (mesmo que infeliz)."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor corre√ß√£o para evitar perda de mensagens durante quedas do servidor da fila?",
      "options": [
        {
          "id": "fix-1",
          "text": "Habilitar persist√™ncia de mensagens ‚Äî gravar mensagens em disco (write-ahead log) antes de confirm√°-las para que sobrevivam a quedas do servidor",
          "correct": true,
          "feedback": "Correto! Filas de mensagens dur√°veis persistem as mensagens em disco antes de confirmar o recebimento. Um write-ahead log (WAL) garante que, mesmo se o servidor cair, as mensagens possam ser recuperadas do disco ao reiniciar. Isso troca um pouco de lat√™ncia de escrita por entrega garantida ‚Äî um requisito cr√≠tico para sistemas como despacho de emerg√™ncia."
        },
        {
          "id": "fix-2",
          "text": "Adicionar um segundo servidor de fila em mem√≥ria como backup para garantir alta disponibilidade",
          "correct": false,
          "feedback": "Um segundo servidor em mem√≥ria ajuda com disponibilidade, mas ambos os servidores ainda perdem dados ao cair. Se o prim√°rio cair antes de replicar para o backup, as mensagens ainda s√£o perdidas. Durabilidade real requer persist√™ncia em disco, n√£o apenas mais mem√≥ria."
        },
        {
          "id": "fix-3",
          "text": "Fazer o sistema de recebimento reenviar mensagens automaticamente se a fila n√£o responder em 5 segundos",
          "correct": false,
          "feedback": "Retentativas ajudam quando a fila est√° temporariamente indispon√≠vel, mas a fila confirmou todas as 23 mensagens antes de cair. O sistema de recebimento n√£o tem raz√£o para reenviar ‚Äî ele pensa que a entrega foi bem-sucedida. As mensagens precisam ser dur√°veis dentro da pr√≥pria fila."
        },
        {
          "id": "fix-4",
          "text": "Aumentar a aloca√ß√£o de mem√≥ria do servidor da fila para evitar falhas causadas por falta de mem√≥ria",
          "correct": false,
          "feedback": "Mais mem√≥ria reduz a probabilidade de falhas por falta de mem√≥ria, mas n√£o as elimina. Qualquer falha ‚Äî falta de mem√≥ria, falha de hardware, queda de energia ‚Äî ainda destruiria todas as mensagens em mem√≥ria. A corre√ß√£o deve garantir que as mensagens sobrevivam a qualquer tipo de falha."
        }
      ]
    }
  },
  "conceptId": "message-durability",
  "badge": {
    "name": "Salvador de Despachos",
    "icon": "üì®"
  }
}