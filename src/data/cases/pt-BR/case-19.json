{
  "id": "case-19",
  "number": 19,
  "title": "A Pris√£o Duplicada",
  "subtitle": "Entrega duplicada de mensagens faz o mesmo mandado ser processado duas vezes",
  "brief": {
    "narrative": "O Oficial Martinez acabou de prender o suspeito James Kowalski pelo mandado #W-8834 na esquina da 4¬™ com a Main. Cinco minutos depois, o Oficial Chen prendeu o mesmo James Kowalski pelo mesmo mandado #W-8834 em outro local ‚Äî porque a fila de despacho entregou a mensagem do mandado de pris√£o duas vezes. O sistema de processamento de mandados criou dois registros de pris√£o, despachou duas unidades, e agora h√° uma queixa de deten√ß√£o indevida. A garantia de entrega 'at-least-once' da fila de mensagens significa que ela √†s vezes re-entrega mensagens ap√≥s um timeout, e o processador de mandados executa cegamente cada mensagem que recebe sem verificar duplicatas. O Chefe Partition quer saber por que o sistema n√£o consegue lidar com uma simples re-entrega sem fazer a mesma pris√£o duas vezes, Detetive.",
    "symptoms": [
      "Mesmo mandado de pris√£o #W-8834 processado e despachado duas vezes",
      "Dois oficiais prenderam o mesmo suspeito independentemente",
      "Registro de pris√£o duplicado criado no sistema de autua√ß√£o",
      "Fila de mensagens re-entregou a mensagem do mandado ap√≥s timeout do consumidor"
    ],
    "objective": "Identificar por que a entrega duplicada de mensagens causou processamento duplicado e recomendar uma estrat√©gia de idempot√™ncia."
  },
  "diagram": {
    "nodes": [
      {
        "id": "warrant-system",
        "type": "server",
        "label": "Warrant Issuing System",
        "status": "healthy",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Sistema de Emiss√£o de Mandados",
          "logs": [
            "[16:00:00] INFO: Warrant #W-8834 issued for James Kowalski",
            "[16:00:01] INFO: Message published to dispatch queue (message-id: msg-7721)"
          ],
          "data": {
            "Warrant": "#W-8834",
            "Suspect": "James Kowalski",
            "Messages Published": "1 (single publish)",
            "Status": "HEALTHY"
          },
          "status": "Publicou exatamente uma mensagem. A duplica√ß√£o aconteceu adiante no fluxo."
        }
      },
      {
        "id": "message-queue",
        "type": "server",
        "label": "Dispatch Queue",
        "status": "degraded",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Fila de Mensagens de Despacho",
          "logs": [
            "[16:00:01] INFO: Message msg-7721 received and queued",
            "[16:00:02] INFO: Message msg-7721 delivered to consumer (attempt 1)",
            "[16:00:32] WARN: No ACK received within 30s timeout ‚Äî assuming consumer failed",
            "[16:00:33] INFO: Message msg-7721 re-delivered to consumer (attempt 2)",
            "[16:00:35] INFO: ACK received for msg-7721 (from attempt 1, delayed)"
          ],
          "data": {
            "Delivery Guarantee": "At-least-once",
            "Message ID": "msg-7721",
            "Deliveries": "2 (original + re-delivery)",
            "ACK Timeout": "30 seconds",
            "Status": "WORKING AS DESIGNED (at-least-once)"
          },
          "status": "Fila re-entregou mensagem ap√≥s timeout de ACK. Este √© o comportamento esperado de at-least-once."
        }
      },
      {
        "id": "warrant-processor",
        "type": "server",
        "label": "Warrant Processor",
        "status": "degraded",
        "position": { "x": 600, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo Processador de Mandados",
          "logs": [
            "[16:00:02] INFO: Processing warrant #W-8834 (message attempt 1)",
            "[16:00:05] INFO: Arrest record created ‚Äî booking #BK-1190",
            "[16:00:06] INFO: Unit dispatched to execute warrant #W-8834",
            "[16:00:33] INFO: Processing warrant #W-8834 (message attempt 2 ‚Äî DUPLICATE)",
            "[16:00:35] INFO: Arrest record created ‚Äî booking #BK-1191 (DUPLICATE)",
            "[16:00:36] INFO: Second unit dispatched for same warrant #W-8834"
          ],
          "data": {
            "Idempotency Check": "NONE",
            "Processed Message IDs": "Not tracked",
            "Duplicate Detection": "Not implemented",
            "Bookings Created": "2 (should be 1)",
            "Units Dispatched": "2 (should be 1)"
          },
          "status": "Processou ambas as entregas como novas ‚Äî sem detec√ß√£o de duplicatas."
        }
      },
      {
        "id": "booking-db",
        "type": "database",
        "label": "Booking Database",
        "status": "degraded",
        "position": { "x": 350, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Banco de Dados de Autua√ß√µes",
          "logs": [
            "[16:00:05] INFO: INSERT booking #BK-1190 (warrant #W-8834)",
            "[16:00:35] INFO: INSERT booking #BK-1191 (warrant #W-8834) ‚Äî DUPLICATE"
          ],
          "data": {
            "Booking #BK-1190": "Warrant #W-8834 ‚Äî James Kowalski",
            "Booking #BK-1191": "Warrant #W-8834 ‚Äî James Kowalski (DUPLICATE)",
            "Unique Constraint on Warrant": "NOT CONFIGURED",
            "Total Duplicate Records": "1 pair"
          },
          "status": "Dois registros de autua√ß√£o para o mesmo mandado. Sem constraint de unicidade."
        }
      },
      {
        "id": "officers",
        "type": "client",
        "label": "Patrol Officers",
        "status": "degraded",
        "position": { "x": 600, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Oficiais de Patrulha",
          "logs": [
            "[16:05:00] INFO: Officer Martinez arrested J. Kowalski at 4th & Main",
            "[16:10:00] INFO: Officer Chen arrested J. Kowalski at 7th & Oak (DUPLICATE)"
          ],
          "data": {
            "Arrests for #W-8834": "2 (should be 1)",
            "Officers Dispatched": "2 (should be 1)",
            "Wrongful Detention Complaint": "Filed"
          },
          "status": "Dois oficiais prenderam independentemente a mesma pessoa pelo mesmo mandado."
        }
      }
    ],
    "edges": [
      { "id": "e-warrant-queue", "source": "warrant-system", "target": "message-queue", "label": "publish (1x)", "animated": true, "style": "normal" },
      { "id": "e-queue-processor", "source": "message-queue", "target": "warrant-processor", "label": "delivered 2x", "animated": true, "style": "slow" },
      { "id": "e-processor-db", "source": "warrant-processor", "target": "booking-db", "label": "duplicate writes", "animated": true, "style": "slow" },
      { "id": "e-processor-officers", "source": "warrant-processor", "target": "officers", "label": "duplicate dispatch", "animated": true, "style": "slow" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz da pris√£o duplicada?",
      "options": [
        {
          "id": "rc-1",
          "text": "O sistema de emiss√£o de mandados publicou a mensagem duas vezes acidentalmente por um bug de l√≥gica",
          "correct": false,
          "feedback": "O sistema de mandados publicou exatamente uma mensagem. A duplica√ß√£o aconteceu porque a fila re-entregou a mensagem ap√≥s um timeout de ACK ‚Äî o que √© comportamento normal de entrega 'at-least-once'."
        },
        {
          "id": "rc-2",
          "text": "O processador de mandados n√£o possui idempot√™ncia ‚Äî ele processa cada mensagem como nova sem verificar se j√° tratou aquele mandado",
          "correct": true,
          "feedback": "Correto! O processador de mandados processa cegamente cada mensagem que recebe sem rastrear quais mandados j√° foram tratados. Em um sistema de entrega at-least-once, entregas duplicadas s√£o esperadas. Consumidores devem ser idempotentes ‚Äî devem detectar e tratar com seguran√ßa mensagens duplicadas para produzir o mesmo resultado independentemente de quantas vezes uma mensagem √© entregue."
        },
        {
          "id": "rc-3",
          "text": "A fila de mensagens tem um bug espec√≠fico no c√≥digo que causa entrega duplicada de mensagens",
          "correct": false,
          "feedback": "A fila est√° funcionando conforme projetado. A garantia at-least-once assegura que mensagens nunca s√£o perdidas, mas significa que podem ser entregues mais de uma vez (por exemplo, ap√≥s timeouts de ACK). Este √© um tradeoff conhecido, e os consumidores devem ser projetados para lidar com isso."
        },
        {
          "id": "rc-4",
          "text": "O timeout de ACK de 30 segundos est√° muito curto, causando re-entrega prematura das mensagens",
          "correct": false,
          "feedback": "Um timeout maior reduziria a frequ√™ncia de re-entregas, mas n√£o pode elimin√°-las. Problemas de rede, rein√≠cios de consumidores e outras falhas podem disparar re-entregas. O consumidor deve ser idempotente independentemente das configura√ß√µes de timeout."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor corre√ß√£o para evitar processamento duplicado de mensagens re-entregues?",
      "options": [
        {
          "id": "fix-1",
          "text": "Mudar para entrega exactly-once configurando a fila de mensagens para nunca re-entregar mensagens",
          "correct": false,
          "feedback": "Entrega truly exactly-once √© extremamente dif√≠cil de alcan√ßar em sistemas distribu√≠dos e a maioria das implementa√ß√µes de filas n√£o a suporta. A abordagem padr√£o √© entrega at-least-once combinada com consumidores idempotentes. √â mais simples e mais confi√°vel."
        },
        {
          "id": "fix-2",
          "text": "Tornar o processador de mandados idempotente ‚Äî rastrear IDs de mensagens/mandados processados e ignorar duplicatas",
          "correct": true,
          "feedback": "Correto! Um consumidor idempotente rastreia quais mensagens (ou chaves de neg√≥cio como IDs de mandados) j√° foram processadas. Quando uma duplicata chega, ele a reconhece e pula o processamento. Isso pode ser feito com uma tabela de mensagens processadas, uma constraint de unicidade no ID do mandado no banco de dados de autua√ß√µes, ou uma chave de idempot√™ncia. O resultado √© o mesmo independentemente de a mensagem ser entregue uma ou dez vezes."
        },
        {
          "id": "fix-3",
          "text": "Aumentar o timeout de ACK para 5 minutos para reduzir a chance de re-entrega prematura e duplicatas",
          "correct": false,
          "feedback": "Um timeout maior reduz re-entregas, mas introduz um problema pior: se um consumidor genuinamente falhar, a mensagem n√£o ser√° re-entregue por 5 minutos. E duplicatas ainda podem acontecer por outras causas (parti√ß√µes de rede, rein√≠cios de consumidores). Idempot√™ncia √© a solu√ß√£o robusta."
        },
        {
          "id": "fix-4",
          "text": "Adicionar uma camada de deduplication na fila de mensagens para filtrar automaticamente entregas duplicadas",
          "correct": false,
          "feedback": "Deduplica√ß√£o no n√≠vel da fila pode ajudar, mas s√≥ captura re-entregas da mesma mensagem exata. N√£o protege contra duplicatas no n√≠vel da aplica√ß√£o ou mensagens diferentes para a mesma entidade de neg√≥cio. Idempot√™ncia no lado do consumidor √© a abordagem mais abrangente e confi√°vel."
        }
      ]
    }
  },
  "conceptId": "idempotency",
  "badge": {
    "name": "Detetive de Duplicatas",
    "icon": "üîç"
  }
}