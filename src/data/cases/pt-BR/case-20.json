{
  "id": "case-20",
  "number": 20,
  "title": "O Pipeline Congestionado",
  "subtitle": "Fila de despacho transborda enquanto o servi√ßo consumidor falha silenciosamente",
  "brief": {
    "narrative": "O sistema de despacho de emerg√™ncia de Distributia parou completamente. Oficiais est√£o reportando que novas atribui√ß√µes de ocorr√™ncias n√£o est√£o chegando ‚Äî viaturas est√£o paradas enquanto chamadas de emerg√™ncia se acumulam. A fila de despacho, que normalmente processa centenas de atribui√ß√µes por minuto, cresceu para mais de 50.000 mensagens pendentes. O lado produtor (central de atendimento) continua empurrando novas ordens de despacho, mas nada est√° sendo consumido do outro lado. O Chefe Partition est√° furioso ‚Äî criminosos est√£o escapando enquanto oficiais aguardam atribui√ß√µes que nunca chegam.",
    "symptoms": [
      "Atribui√ß√µes de despacho pararam de chegar √†s unidades de patrulha h√° 45 minutos",
      "A profundidade da fila de mensagens cresceu de ~100 para mais de 50.000 mensagens",
      "A central de atendimento ainda consegue enviar novas ordens de despacho sem erros",
      "O uso de mem√≥ria no broker da fila est√° se aproximando de n√≠veis cr√≠ticos"
    ],
    "objective": "Identificar por que o pipeline de despacho est√° congestionado e recomendar uma corre√ß√£o para restaurar o fluxo e prevenir futuras crises de backpressure."
  },
  "diagram": {
    "nodes": [
      {
        "id": "call-center",
        "type": "client",
        "label": "Call Center (Producer)",
        "status": "healthy",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Central de Atendimento (Produtor)",
          "logs": [
            "[03:15:01] INFO: Dispatch order #48,221 published to queue",
            "[03:15:02] INFO: Dispatch order #48,222 published to queue",
            "[03:15:02] INFO: Publish rate: 12 msgs/sec",
            "[03:15:03] WARN: Queue broker reporting high memory usage"
          ],
          "data": {
            "Status": "ONLINE",
            "Publish Rate": "12 msgs/sec",
            "Messages Sent (last hour)": "43,200",
            "Errors": "0"
          },
          "status": "Produtor est√° operando normalmente. Mensagens est√£o sendo aceitas pelo broker."
        }
      },
      {
        "id": "queue-broker",
        "type": "server",
        "label": "Dispatch Queue Broker",
        "status": "degraded",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Broker da Fila de Despacho",
          "logs": [
            "[02:30:00] INFO: Consumer 'patrol-dispatcher' disconnected",
            "[02:30:01] WARN: No active consumers on queue 'dispatch-orders'",
            "[02:45:00] WARN: Queue depth exceeded 10,000 messages",
            "[03:00:00] WARN: Queue depth exceeded 30,000 messages",
            "[03:15:00] CRITICAL: Memory usage at 91% ‚Äî queue depth 50,412",
            "[03:15:01] WARN: Approaching max memory limit, may start dropping messages"
          ],
          "data": {
            "Status": "DEGRADED",
            "Queue Depth": "50,412 messages",
            "Active Consumers": "0",
            "Memory Usage": "91%",
            "Max Memory": "4 GB",
            "Backpressure Policy": "None configured"
          },
          "status": "Fila enchendo sem consumidores drenando. Nenhum mecanismo de backpressure configurado."
        }
      },
      {
        "id": "consumer-service",
        "type": "server",
        "label": "Patrol Dispatcher (Consumer)",
        "status": "failed",
        "position": { "x": 600, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Despachante de Patrulha (Consumidor)",
          "logs": [
            "[02:29:55] ERROR: OutOfMemoryError in message handler",
            "[02:29:56] ERROR: Unhandled exception ‚Äî process crashing",
            "[02:29:57] FATAL: Consumer process terminated (exit code 137)",
            "[02:29:57] INFO: No automatic restart policy configured"
          ],
          "data": {
            "Status": "CRASHED",
            "Last Active": "02:29:57",
            "Restart Policy": "None",
            "Messages Processed Before Crash": "5,102"
          },
          "status": "Consumidor falhou por OutOfMemoryError h√° 45 minutos. Sem pol√≠tica de rein√≠cio autom√°tico."
        }
      },
      {
        "id": "patrol-units",
        "type": "client",
        "label": "Patrol Units",
        "status": "degraded",
        "position": { "x": 600, "y": 280 },
        "inspectable": true,
        "inspectData": {
          "title": "Unidades de Patrulha",
          "logs": [
            "[02:30:05] WARN: No new dispatch orders received",
            "[02:45:00] WARN: Still no dispatch orders ‚Äî 15 min gap",
            "[03:15:00] WARN: Officers idle for 45 minutes, no assignments"
          ],
          "data": {
            "Status": "IDLE",
            "Active Patrols": "24",
            "Pending Assignments": "0",
            "Last Assignment Received": "02:29:55"
          },
          "status": "Nenhuma ordem de despacho chegando. Oficiais est√£o ociosos e sem atribui√ß√µes."
        }
      }
    ],
    "edges": [
      { "id": "e-cc-broker", "source": "call-center", "target": "queue-broker", "label": "publish orders", "animated": true, "style": "normal" },
      { "id": "e-broker-consumer", "source": "queue-broker", "target": "consumer-service", "label": "consume orders", "animated": false, "style": "broken" },
      { "id": "e-consumer-patrols", "source": "consumer-service", "target": "patrol-units", "label": "assign patrols", "animated": false, "style": "broken" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz do congestionamento no pipeline de despacho?",
      "options": [
        {
          "id": "rc-1",
          "text": "A central de atendimento est√° produzindo mensagens r√°pido demais para o broker e os consumidores conseguirem processar",
          "correct": false,
          "feedback": "A taxa de produ√ß√£o de 12 msgs/seg √© normal. O problema √© que zero consumidores est√£o drenando a fila ‚Äî o servi√ßo consumidor falhou e nunca reiniciou."
        },
        {
          "id": "rc-2",
          "text": "O servi√ßo consumidor falhou e n√£o tem pol√≠tica de rein√≠cio, ent√£o as mensagens se acumulam sem nada processando ‚Äî uma falha de backpressure",
          "correct": true,
          "feedback": "Correto! O despachante de patrulha consumidor falhou h√° 45 minutos e n√£o tem pol√≠tica de rein√≠cio autom√°tico. Com o produtor ainda publicando e zero consumidores drenando a fila, as mensagens se acumulam sem limites. O sistema carece de qualquer mecanismo de backpressure para desacelerar os produtores quando os consumidores n√£o conseguem acompanhar."
        },
        {
          "id": "rc-3",
          "text": "O broker da fila ficou sem mem√≥ria e parou de aceitar novas mensagens dos produtores",
          "correct": false,
          "feedback": "O broker est√° em 91% de mem√≥ria, mas ainda n√£o parou ‚Äî continua aceitando mensagens. O problema real √© que nenhum consumidor est√° drenando a fila. O problema de mem√≥ria √© um sintoma da falha de backpressure, n√£o a causa."
        },
        {
          "id": "rc-4",
          "text": "Uma parti√ß√£o de rede separou o broker da fila das unidades de patrulha no campo",
          "correct": false,
          "feedback": "As unidades de patrulha n√£o se conectam diretamente ao broker ‚Äî o servi√ßo consumidor faz isso. Os logs do consumidor mostram que ele falhou por um OutOfMemoryError, n√£o por um problema de rede."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor corre√ß√£o para prevenir este congestionamento de pipeline no futuro?",
      "options": [
        {
          "id": "fix-1",
          "text": "Implementar controles de backpressure: rein√≠cio autom√°tico de consumidores, limites de tamanho da fila e desacelera√ß√£o de produtores quando a fila est√° cheia",
          "correct": true,
          "feedback": "Correto! Uma estrat√©gia adequada de backpressure inclui: (1) rein√≠cio autom√°tico de consumidores que falharam, (2) defini√ß√£o de profundidade m√°xima da fila para evitar crescimento ilimitado, e (3) sinalizar aos produtores para desacelerar quando os consumidores n√£o conseguem acompanhar. Isso evita que o sistema entre em espiral descontrolada."
        },
        {
          "id": "fix-2",
          "text": "Aumentar a mem√≥ria do broker para 64 GB para comportar um volume muito maior de mensagens",
          "correct": false,
          "feedback": "Mais mem√≥ria apenas adia o problema ‚Äî se os consumidores est√£o fora do ar, a fila vai eventualmente encher qualquer quantidade de mem√≥ria. Voc√™ precisa de backpressure para parar o crescimento ilimitado e garantir que os consumidores permane√ßam ativos."
        },
        {
          "id": "fix-3",
          "text": "Fazer a central de atendimento enviar ordens de despacho diretamente para as unidades, ignorando a fila",
          "correct": false,
          "feedback": "Remover a fila elimina o buffering que ajuda a lidar com picos de tr√°fego. A fila √© uma boa escolha arquitetural ‚Äî ela s√≥ precisa de controles adequados de backpressure e resili√™ncia de consumidores."
        },
        {
          "id": "fix-4",
          "text": "Configurar mensagens para expirar ap√≥s 5 minutos para que as antigas sejam automaticamente deletadas da fila",
          "correct": false,
          "feedback": "Descartar ordens de despacho significa que chamadas de emerg√™ncia se perdem completamente. Voc√™ precisa de backpressure para gerenciar o fluxo, n√£o de expira√ß√£o de mensagens que silenciosamente descarta atribui√ß√µes cr√≠ticas."
        }
      ]
    }
  },
  "conceptId": "backpressure",
  "badge": {
    "name": "V√°lvula de Press√£o",
    "icon": "üîß"
  }
}