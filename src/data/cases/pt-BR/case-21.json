{
  "id": "case-21",
  "number": 21,
  "title": "A Desordem",
  "subtitle": "Relat√≥rios de ocorr√™ncias chegam embaralhados enquanto consumidores paralelos desorganizam a sequ√™ncia",
  "brief": {
    "narrative": "O escrit√≥rio do Promotor de Distributia est√° no caos. Eles est√£o construindo uma linha do tempo para um grande caso de crime organizado, mas os relat√≥rios de ocorr√™ncias est√£o chegando completamente fora de sequ√™ncia. Um assalto que aconteceu √†s 22h est√° aparecendo depois de um depoimento de testemunha das 2h do dia seguinte. A cadeia de evid√™ncias n√£o faz sentido. O sistema de relat√≥rios usa uma fila de mensagens com tr√™s consumidores paralelos para acelerar o processamento ‚Äî mas parece que a velocidade teve um custo terr√≠vel. O Chefe Partition precisa que a linha do tempo seja reconstru√≠da antes do julgamento amanh√£ de manh√£.",
    "symptoms": [
      "Relat√≥rios de ocorr√™ncias no arquivo do Promotor est√£o fora da ordem cronol√≥gica",
      "Eventos de diferentes hor√°rios est√£o intercalados aleatoriamente",
      "O sistema tem tr√™s workers consumidores processando a mesma fila",
      "Relat√≥rios individuais est√£o corretos, mas a ordena√ß√£o est√° errada"
    ],
    "objective": "Determinar por que os relat√≥rios de ocorr√™ncias est√£o chegando fora de ordem e recomendar uma arquitetura que garanta a sequ√™ncia correta."
  },
  "diagram": {
    "nodes": [
      {
        "id": "report-ingestion",
        "type": "client",
        "label": "Report Ingestion API",
        "status": "healthy",
        "position": { "x": 100, "y": 180 },
        "inspectable": true,
        "inspectData": {
          "title": "API de Ingest√£o de Relat√≥rios",
          "logs": [
            "[09:00:01] INFO: Report #501 (Case-77, timestamp 22:00) enqueued",
            "[09:00:01] INFO: Report #502 (Case-77, timestamp 22:15) enqueued",
            "[09:00:02] INFO: Report #503 (Case-77, timestamp 23:30) enqueued",
            "[09:00:02] INFO: Report #504 (Case-77, timestamp 02:00) enqueued",
            "[09:00:02] INFO: All reports enqueued in chronological order"
          ],
          "data": {
            "Status": "ONLINE",
            "Reports Enqueued Today": "1,204",
            "Ordering at Enqueue": "Chronological (correct)"
          },
          "status": "Relat√≥rios est√£o sendo enfileirados na ordem cronol√≥gica correta."
        }
      },
      {
        "id": "message-queue",
        "type": "server",
        "label": "Report Processing Queue",
        "status": "healthy",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Fila de Processamento de Relat√≥rios",
          "logs": [
            "[09:00:01] INFO: Report #501 delivered to Consumer-A",
            "[09:00:01] INFO: Report #502 delivered to Consumer-B",
            "[09:00:02] INFO: Report #503 delivered to Consumer-C",
            "[09:00:02] INFO: Report #504 delivered to Consumer-A",
            "[09:00:03] INFO: Consumer-B ACK report #502 (processed in 45ms)",
            "[09:00:03] INFO: Consumer-C ACK report #503 (processed in 30ms)",
            "[09:00:04] INFO: Consumer-A ACK report #501 (processed in 210ms)",
            "[09:00:04] INFO: Consumer-A ACK report #504 (processed in 50ms)"
          ],
          "data": {
            "Status": "ONLINE",
            "Consumer Count": "3",
            "Delivery Mode": "Round-robin",
            "Partition Key": "None configured",
            "Ordering Guarantee": "Per-consumer only"
          },
          "status": "Fila distribui mensagens em round-robin entre 3 consumidores. Sem partition key configurada para roteamento por caso."
        }
      },
      {
        "id": "consumer-a",
        "type": "server",
        "label": "Consumer A",
        "status": "healthy",
        "position": { "x": 550, "y": 30 },
        "inspectable": true,
        "inspectData": {
          "title": "Worker Consumidor A",
          "logs": [
            "[09:00:01] INFO: Processing report #501 (Case-77, ts 22:00)",
            "[09:00:04] INFO: Report #501 written to DA system ‚Äî took 210ms",
            "[09:00:04] INFO: Processing report #504 (Case-77, ts 02:00)",
            "[09:00:04] INFO: Report #504 written to DA system ‚Äî took 50ms"
          ],
          "data": {
            "Status": "ONLINE",
            "Avg Processing Time": "130ms",
            "Reports Processed": "412"
          },
          "status": "Processando normalmente, mas relat√≥rio #501 demorou mais, fazendo #504 ser escrito depois de #502 e #503."
        }
      },
      {
        "id": "consumer-b",
        "type": "server",
        "label": "Consumer B",
        "status": "healthy",
        "position": { "x": 550, "y": 180 },
        "inspectable": true,
        "inspectData": {
          "title": "Worker Consumidor B",
          "logs": [
            "[09:00:01] INFO: Processing report #502 (Case-77, ts 22:15)",
            "[09:00:03] INFO: Report #502 written to DA system ‚Äî took 45ms"
          ],
          "data": {
            "Status": "ONLINE",
            "Avg Processing Time": "48ms",
            "Reports Processed": "398"
          },
          "status": "Consumidor r√°pido ‚Äî terminou relat√≥rio #502 antes do Consumidor A terminar #501."
        }
      },
      {
        "id": "da-system",
        "type": "database",
        "label": "DA Case File DB",
        "status": "degraded",
        "position": { "x": 550, "y": 340 },
        "inspectable": true,
        "inspectData": {
          "title": "Banco de Dados de Autos do Promotor",
          "logs": [
            "[09:00:03] INFO: Report #502 (ts 22:15) inserted at position 1",
            "[09:00:03] INFO: Report #503 (ts 23:30) inserted at position 2",
            "[09:00:04] INFO: Report #501 (ts 22:00) inserted at position 3",
            "[09:00:04] INFO: Report #504 (ts 02:00) inserted at position 4"
          ],
          "data": {
            "Status": "DATA INTEGRITY ISSUE",
            "Case-77 Report Order": "#502, #503, #501, #504",
            "Expected Order": "#501, #502, #503, #504",
            "Total Cases Affected": "187"
          },
          "status": "Relat√≥rios armazenados na ordem de chegada, n√£o na ordem cronol√≥gica. 187 casos t√™m linhas do tempo embaralhadas."
        }
      }
    ],
    "edges": [
      { "id": "e-ingest-queue", "source": "report-ingestion", "target": "message-queue", "label": "enqueue reports", "animated": true, "style": "normal" },
      { "id": "e-queue-a", "source": "message-queue", "target": "consumer-a", "label": "round-robin", "animated": true, "style": "normal" },
      { "id": "e-queue-b", "source": "message-queue", "target": "consumer-b", "label": "round-robin", "animated": true, "style": "normal" },
      { "id": "e-a-da", "source": "consumer-a", "target": "da-system", "label": "write reports", "animated": true, "style": "slow" },
      { "id": "e-b-da", "source": "consumer-b", "target": "da-system", "label": "write reports", "animated": true, "style": "normal" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Por que os relat√≥rios de ocorr√™ncias est√£o chegando fora de ordem no sistema do Promotor?",
      "options": [
        {
          "id": "rc-1",
          "text": "A API de ingest√£o est√° enfileirando relat√≥rios na ordem errada",
          "correct": false,
          "feedback": "Os logs da API de ingest√£o mostram claramente que os relat√≥rios s√£o enfileirados na ordem cronol√≥gica correta. A desordem acontece mais adiante no fluxo."
        },
        {
          "id": "rc-2",
          "text": "M√∫ltiplos consumidores paralelos processam mensagens em velocidades diferentes, ent√£o consumidores mais r√°pidos escrevem mensagens posteriores antes que consumidores mais lentos terminem as anteriores",
          "correct": true,
          "feedback": "Correto! Com distribui√ß√£o round-robin entre 3 consumidores e sem partition key, mensagens do mesmo caso v√£o para consumidores diferentes. Como cada consumidor tem tempos de processamento diferentes, um consumidor r√°pido pode terminar a mensagem N+1 antes de um consumidor lento terminar a mensagem N, destruindo a ordena√ß√£o original."
        },
        {
          "id": "rc-3",
          "text": "O banco de dados do Promotor est√° ordenando os registros incorretamente",
          "correct": false,
          "feedback": "O banco de dados est√° armazenando registros na ordem em que chegam, o que √© padr√£o. O problema √© que eles chegam fora de ordem por causa da arquitetura de consumidores paralelos."
        },
        {
          "id": "rc-4",
          "text": "A fila de mensagens tem um bug que entrega mensagens fora de sequ√™ncia",
          "correct": false,
          "feedback": "A fila entrega mensagens em ordem FIFO para cada consumidor. O problema √© que a distribui√ß√£o round-robin entre m√∫ltiplos consumidores n√£o preserva a ordena√ß√£o global quando os tempos de processamento variam."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor corre√ß√£o para garantir que relat√≥rios de ocorr√™ncias cheguem na ordem correta?",
      "options": [
        {
          "id": "fix-1",
          "text": "Reduzir para um √∫nico consumidor para que todas as mensagens sejam processadas sequencialmente",
          "correct": false,
          "feedback": "Isso corrigiria a ordena√ß√£o, mas destruiria o throughput. Um √∫nico consumidor se torna um gargalo. Existe uma solu√ß√£o melhor que preserva tanto o paralelismo quanto a ordena√ß√£o."
        },
        {
          "id": "fix-2",
          "text": "Usar partition keys (ID do caso) para que todos os relat√≥rios do mesmo caso v√£o para o mesmo consumidor, preservando a ordena√ß√£o por caso",
          "correct": true,
          "feedback": "Correto! Ao particionar pelo ID do caso, todos os relat√≥rios do Caso-77 v√£o para o mesmo consumidor e s√£o processados sequencialmente. Casos diferentes ainda podem ser processados em paralelo entre consumidores. Isso d√° tanto garantias de ordena√ß√£o quanto throughput paralelo."
        },
        {
          "id": "fix-3",
          "text": "Adicionar timestamps a cada relat√≥rio e orden√°-los no banco de dados ap√≥s a inser√ß√£o",
          "correct": false,
          "feedback": "Ordena√ß√£o posterior √© fr√°gil ‚Äî voc√™ precisaria saber quando todos os relat√≥rios de uma janela de tempo chegaram antes de ordenar. Adiciona complexidade e lat√™ncia. Ordena√ß√£o baseada em parti√ß√µes √© mais simples e confi√°vel."
        },
        {
          "id": "fix-4",
          "text": "Fazer todos os consumidores processarem na mesma velocidade padronizando o hardware",
          "correct": false,
          "feedback": "O tempo de processamento varia com base no conte√∫do da mensagem, n√£o apenas no hardware. Jitter de rede, pausas de garbage collection e I/O causam lat√™ncia vari√°vel. Voc√™ n√£o pode garantir tempos iguais de processamento ‚Äî precisa de uma solu√ß√£o arquitetural."
        }
      ]
    }
  },
  "conceptId": "message-ordering",
  "badge": {
    "name": "Guardi√£o da Ordem",
    "icon": "üìã"
  }
}