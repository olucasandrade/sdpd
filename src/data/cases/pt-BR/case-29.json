{
  "id": "case-29",
  "number": 29,
  "title": "O Desastre do DNS",
  "subtitle": "Quando um servidor muda de endere√ßo e ningu√©m recebe o novo",
  "brief": {
    "narrative": "S√£o 2 da manh√£ quando a equipe de infraestrutura da DP de Distributia substitui um servidor com falha no cluster de Rastreamento de Evid√™ncias. O novo servidor entra no ar com um novo endere√ßo IP ‚Äî 10.0.5.47 em vez do antigo 10.0.5.31. Tudo parece saud√°vel do ponto de vista do novo servidor. Mas em minutos, os telefones come√ßam a tocar. O Laborat√≥rio Forense n√£o consegue submeter laudos de evid√™ncias. O portal de Liga√ß√£o com o Tribunal mostra 'Conex√£o Recusada'. O app de Upload de Evid√™ncias da Patrulha est√° morto. O problema? Todos os servi√ßos que se comunicam com o Rastreador de Evid√™ncias t√™m o endere√ßo IP antigo hardcoded nos arquivos de configura√ß√£o. N√£o existe DNS, nem registro de servi√ßos, nem mecanismo de service discovery ‚Äî apenas endere√ßos IP crus espalhados em dezenas de arquivos de config em dezenas de servi√ßos. O Detetive DNS encara um quadro branco coberto de endere√ßos IP e setas, tentando descobrir quais dos 23 servi√ßos que dependem do Rastreador de Evid√™ncias ainda apontam para uma m√°quina que n√£o existe mais.",
    "symptoms": [
      "O Rastreador de Evid√™ncias est√° saud√°vel no novo IP (10.0.5.47) mas inacess√≠vel por outros servi√ßos",
      "Laborat√≥rio Forense, Liga√ß√£o com Tribunal e Upload da Patrulha reportam erros de 'Conex√£o Recusada'",
      "Todos os servi√ßos dependentes t√™m o IP antigo (10.0.5.31) hardcoded nos arquivos de configura√ß√£o",
      "N√£o existe registro centralizado de servi√ßos ou DNS para service discovery interno"
    ],
    "objective": "Identificar por que substituir um servidor quebrou a comunica√ß√£o inter-servi√ßos, e determinar a abordagem correta de service discovery que sobrevive a mudan√ßas de infraestrutura."
  },
  "diagram": {
    "nodes": [
      {
        "id": "evidence-tracker",
        "type": "server",
        "label": "Evidence Tracker (new)",
        "status": "healthy",
        "position": { "x": 400, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Rastreamento de Evid√™ncias (Novo Servidor)",
          "logs": [
            "[02:15:00] INFO: Service started on 10.0.5.47:8080",
            "[02:15:01] INFO: Database connection established",
            "[02:15:02] INFO: Health check passing ‚Äî all systems nominal",
            "[02:16:00] WARN: No incoming requests in 60s ‚Äî unusually quiet",
            "[02:20:00] WARN: Still no incoming requests ‚Äî 5 minutes of silence"
          ],
          "data": {
            "IP Address": "10.0.5.47 (NEW)",
            "Old IP": "10.0.5.31 (DECOMMISSIONED)",
            "Status": "HEALTHY ‚Äî accepting requests",
            "Requests Received": "0 since startup",
            "Registered In": "No service registry exists"
          },
          "status": "O servi√ßo est√° saud√°vel e pronto, mas nenhum cliente consegue encontr√°-lo no novo IP."
        }
      },
      {
        "id": "forensics-lab",
        "type": "client",
        "label": "Forensics Lab",
        "status": "failed",
        "position": { "x": 80, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Portal do Laborat√≥rio Forense",
          "logs": [
            "[02:16:05] INFO: Submitting DNA evidence report for Case #7821",
            "[02:16:05] ERROR: Connection refused to 10.0.5.31:8080",
            "[02:16:10] ERROR: Retry 1 ‚Äî Connection refused to 10.0.5.31:8080",
            "[02:16:15] ERROR: Retry 2 ‚Äî Connection refused to 10.0.5.31:8080",
            "[02:16:20] ERROR: Evidence submission failed ‚Äî Evidence Tracker unreachable"
          ],
          "data": {
            "Config File": "forensics-lab.conf",
            "evidence_tracker_host": "10.0.5.31 (HARDCODED - STALE)",
            "Last Config Update": "6 months ago",
            "Discovery Method": "Manual IP in config file"
          },
          "status": "N√£o consegue alcan√ßar o Rastreador de Evid√™ncias ‚Äî ainda aponta para o IP descomissionado."
        }
      },
      {
        "id": "court-liaison",
        "type": "client",
        "label": "Court Liaison",
        "status": "failed",
        "position": { "x": 80, "y": 220 },
        "inspectable": true,
        "inspectData": {
          "title": "Portal de Liga√ß√£o com o Tribunal",
          "logs": [
            "[02:17:00] INFO: Requesting evidence chain-of-custody for Case #6554",
            "[02:17:01] ERROR: Connection refused to 10.0.5.31:8080",
            "[02:17:30] ERROR: Evidence chain request failed ‚Äî service unreachable"
          ],
          "data": {
            "Config File": "court-liaison.yaml",
            "evidence_api_url": "http://10.0.5.31:8080/api (HARDCODED - STALE)",
            "Last Config Update": "4 months ago",
            "Discovery Method": "Manual IP in config file"
          },
          "status": "N√£o consegue recuperar registros de evid√™ncias ‚Äî apontando para o IP antigo."
        }
      },
      {
        "id": "patrol-upload",
        "type": "client",
        "label": "Patrol Evidence Upload",
        "status": "failed",
        "position": { "x": 80, "y": 390 },
        "inspectable": true,
        "inspectData": {
          "title": "App de Upload de Evid√™ncias da Patrulha",
          "logs": [
            "[02:18:00] INFO: Officer uploading body-cam footage for Incident #9203",
            "[02:18:01] ERROR: Connection refused to 10.0.5.31:8080",
            "[02:18:05] ERROR: Upload failed ‚Äî Evidence Tracker unreachable",
            "[02:18:10] WARN: Queueing upload locally ‚Äî will retry when service available"
          ],
          "data": {
            "Config File": "patrol-upload.env",
            "EVIDENCE_HOST": "10.0.5.31 (HARDCODED - STALE)",
            "Last Config Update": "8 months ago",
            "Queued Uploads": "23 (growing)"
          },
          "status": "N√£o consegue fazer upload de evid√™ncias ‚Äî IP hardcoded aponta para servidor descomissionado."
        }
      }
    ],
    "edges": [
      { "id": "e-forensics-evidence", "source": "forensics-lab", "target": "evidence-tracker", "label": "10.0.5.31 (wrong IP)", "animated": false, "style": "broken" },
      { "id": "e-court-evidence", "source": "court-liaison", "target": "evidence-tracker", "label": "10.0.5.31 (wrong IP)", "animated": false, "style": "broken" },
      { "id": "e-patrol-evidence", "source": "patrol-upload", "target": "evidence-tracker", "label": "10.0.5.31 (wrong IP)", "animated": false, "style": "broken" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz de todos os servi√ßos perderem contato com o Rastreador de Evid√™ncias?",
      "options": [
        {
          "id": "rc-1",
          "text": "A equipe de infraestrutura n√£o atualizou os arquivos de configura√ß√£o de todos os servi√ßos ap√≥s a substitui√ß√£o",
          "correct": false,
          "feedback": "Embora a corre√ß√£o imediata seja atualizar as configs, culpar a equipe de opera√ß√µes ignora o problema sist√™mico. Com mais de 23 servi√ßos dependentes, cada um com IP hardcoded, atualiza√ß√µes manuais de configura√ß√£o s√£o propensas a erro e n√£o escalam. A causa raiz √© a arquitetura: n√£o existe mecanismo de service discovery, ent√£o qualquer mudan√ßa de IP requer rastrear e atualizar manualmente cada cliente."
        },
        {
          "id": "rc-2",
          "text": "O novo servidor deveria ter recebido o mesmo endere√ßo IP do antigo para manter compatibilidade",
          "correct": false,
          "feedback": "Reutilizar IPs √© fr√°gil e nem sempre poss√≠vel (subnet diferente, ambiente cloud, etc.). O problema real √© que os servi√ßos dependem de um endere√ßo IP espec√≠fico. Service discovery adequado desacopla a identidade do servi√ßo da localiza√ß√£o na rede."
        },
        {
          "id": "rc-3",
          "text": "Endere√ßos IP hardcoded sem mecanismo de service discovery significam que qualquer mudan√ßa de infraestrutura quebra a comunica√ß√£o inter-servi√ßos",
          "correct": true,
          "feedback": "Correto! Quando servi√ßos se encontram por IPs hardcoded, cada mudan√ßa de infraestrutura (substitui√ß√£o de servidor, escalonamento, failover, migra√ß√£o) requer atualiza√ß√£o manual da configura√ß√£o de cada servi√ßo dependente. Isso n√£o escala e √© extremamente fr√°gil. Service discovery ‚Äî seja via DNS, um registro de servi√ßos como Consul/Eureka, ou abstra√ß√µes de servi√ßo do Kubernetes ‚Äî desacopla a identidade do servi√ßo da localiza√ß√£o na rede, permitindo que a infraestrutura mude sem quebrar a comunica√ß√£o."
        },
        {
          "id": "rc-4",
          "text": "O Rastreador de Evid√™ncias deveria estar configurado para escutar no IP 10.0.5.31 mesmo em um novo servidor",
          "correct": false,
          "feedback": "Fazer bind a um IP que pertence a outra m√°quina √© uma configura√ß√£o de rede problem√°tica esperando para acontecer. A solu√ß√£o n√£o √© for√ßar nova infraestrutura a imitar IPs antigos ‚Äî √© ter uma camada de discovery que abstraia endere√ßos IP completamente."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor solu√ß√£o de longo prazo para prevenir este tipo de incidente?",
      "options": [
        {
          "id": "fix-1",
          "text": "Criar um arquivo de configura√ß√£o compartilhado com todos os IPs para que haja apenas um lugar a atualizar",
          "correct": false,
          "feedback": "Um arquivo de configura√ß√£o centralizado √© levemente melhor que configs espalhadas, mas ainda requer atualiza√ß√µes manuais quando IPs mudam. Tamb√©m cria um ponto √∫nico de falha. Service discovery de verdade √© din√¢mico ‚Äî servi√ßos se registram automaticamente quando iniciam."
        },
        {
          "id": "fix-2",
          "text": "Implementar um sistema de service discovery onde servi√ßos se registram e clientes consultam endpoints dinamicamente",
          "correct": true,
          "feedback": "Correto! Com service discovery (baseado em DNS como CoreDNS, baseado em registro como Consul/Eureka, ou nativo da plataforma como Kubernetes Services), o Rastreador de Evid√™ncias se registra na inicializa√ß√£o com seu IP atual. Clientes buscam 'evidence-tracker' pelo nome em vez do IP. Quando o servidor √© substitu√≠do, a nova inst√¢ncia se registra automaticamente e os clientes a encontram imediatamente. Sem mudan√ßas manuais de configura√ß√£o, sem IPs hardcoded, e a infraestrutura pode mudar livremente."
        },
        {
          "id": "fix-3",
          "text": "Usar um load balancer com IP est√°tico na frente do Rastreador de Evid√™ncias para clientes se conectarem",
          "correct": false,
          "feedback": "Um load balancer ajuda com um √∫nico servi√ßo, mas n√£o resolve o problema sist√™mico. Voc√™ precisaria de um load balancer para cada servi√ßo, e esses load balancers tamb√©m precisariam ser descobertos. Um sistema de service discovery adequado √© a solu√ß√£o gen√©rica que lida com toda comunica√ß√£o inter-servi√ßos."
        },
        {
          "id": "fix-4",
          "text": "Escrever um script automatizado que atualiza os arquivos de configura√ß√£o quando o IP de um servidor mudar",
          "correct": false,
          "feedback": "Automatizar atualiza√ß√µes de config √© melhor que mudan√ßas manuais, mas ainda requer reiniciar servi√ßos para carregar novas configs, saber quais servi√ßos dependem de quais, e lidar com o gap entre a mudan√ßa de IP e a propaga√ß√£o da config. Service discovery torna tudo isso din√¢mico e em tempo real."
        }
      ]
    }
  },
  "conceptId": "service-discovery",
  "badge": {
    "name": "Agente de Discovery",
    "icon": "üî≠"
  }
}