{
  "id": "case-30",
  "number": 30,
  "title": "O Distrito do Deadlock",
  "subtitle": "Dois servi√ßos travados em um impasse eterno",
  "brief": {
    "narrative": "√â hora da troca de turno na DP de Distributia, e o sistema congelou completamente. O Servi√ßo de Registro de Armas e o Servi√ßo de Plant√£o dos Oficiais est√£o ambos completamente sem resposta ‚Äî sem erros, sem crashes, apenas sil√™ncio. A investiga√ß√£o revela um abra√ßo mortal: √†s 18:00:01, o Registro de Armas adquiriu um lock no registro de atribui√ß√£o de arma do Oficial #347 e ent√£o tentou travar o status de plant√£o do oficial para verificar se ele est√° em turno. No exato mesmo instante, o Servi√ßo de Plant√£o dos Oficiais adquiriu um lock no status de plant√£o do Oficial #347 e ent√£o tentou travar o registro de atribui√ß√£o de arma para atualizar a lista de equipamentos do oficial. Cada servi√ßo mant√©m o lock que o outro precisa, e nenhum vai liberar seu lock at√© conseguir o outro. Est√£o em deadlock ‚Äî congelados em uma espera infinita, mantendo toda a troca de turno como ref√©m. O Capit√£o Gridlock tem 200 oficiais esperando para devolver suas armas e ir para casa, e outros 200 esperando para se armar e iniciar a patrulha. Ningu√©m consegue fazer nenhuma das duas coisas.",
    "symptoms": [
      "O Servi√ßo de Registro de Armas e o Servi√ßo de Plant√£o dos Oficiais ambos completamente sem resposta (sem erros, sem timeouts)",
      "Ambos os servi√ßos mostram 100% de utiliza√ß√£o de threads mas 0% de CPU ‚Äî threads est√£o bloqueadas, n√£o trabalhando",
      "Processo de troca de turno congelado ‚Äî oficiais n√£o conseguem devolver nem retirar armas",
      "Thread dumps mostram ambos os servi√ßos aguardando locks mantidos pelo outro"
    ],
    "objective": "Identificar o deadlock distribu√≠do entre dois servi√ßos e determinar a estrat√©gia correta para prevenir e resolver deadlocks em sistemas distribu√≠dos."
  },
  "diagram": {
    "nodes": [
      {
        "id": "weapon-registry",
        "type": "server",
        "label": "Weapon Registry",
        "status": "failed",
        "position": { "x": 100, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Registro de Armas",
          "logs": [
            "[18:00:01] INFO: Processing weapon return for Officer #347",
            "[18:00:01] INFO: LOCK ACQUIRED ‚Äî weapon_assignment_347",
            "[18:00:01] INFO: Requesting lock on duty_status_347 to verify shift status...",
            "[18:00:01] WARN: Waiting for lock on duty_status_347 ‚Äî held by Officer Duty Service",
            "[18:00:31] WARN: Still waiting for lock on duty_status_347 ‚Äî 30s elapsed",
            "[18:02:01] WARN: Still waiting for lock on duty_status_347 ‚Äî 120s elapsed"
          ],
          "data": {
            "Status": "DEADLOCKED",
            "Lock Held": "weapon_assignment_347",
            "Lock Waiting For": "duty_status_347",
            "Lock Timeout": "NONE (waits indefinitely)",
            "Blocked Threads": "50/50",
            "CPU Usage": "0.1% (threads sleeping, not working)"
          },
          "status": "Mantendo lock de arma, esperando indefinidamente pelo lock de status de plant√£o mantido pelo Servi√ßo de Plant√£o."
        }
      },
      {
        "id": "officer-duty",
        "type": "server",
        "label": "Officer Duty Service",
        "status": "failed",
        "position": { "x": 550, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Plant√£o dos Oficiais",
          "logs": [
            "[18:00:01] INFO: Processing shift change for Officer #347",
            "[18:00:01] INFO: LOCK ACQUIRED ‚Äî duty_status_347",
            "[18:00:01] INFO: Requesting lock on weapon_assignment_347 to update equipment list...",
            "[18:00:01] WARN: Waiting for lock on weapon_assignment_347 ‚Äî held by Weapon Registry",
            "[18:00:31] WARN: Still waiting for lock on weapon_assignment_347 ‚Äî 30s elapsed",
            "[18:02:01] WARN: Still waiting for lock on weapon_assignment_347 ‚Äî 120s elapsed"
          ],
          "data": {
            "Status": "DEADLOCKED",
            "Lock Held": "duty_status_347",
            "Lock Waiting For": "weapon_assignment_347",
            "Lock Timeout": "NONE (waits indefinitely)",
            "Blocked Threads": "50/50",
            "CPU Usage": "0.2% (threads sleeping, not working)"
          },
          "status": "Mantendo lock de status de plant√£o, esperando indefinidamente pelo lock de arma mantido pelo Registro de Armas."
        }
      },
      {
        "id": "shift-terminal",
        "type": "client",
        "label": "Shift Change Terminal",
        "status": "failed",
        "position": { "x": 325, "y": 300 },
        "inspectable": true,
        "inspectData": {
          "title": "Terminal de Troca de Turno",
          "logs": [
            "[18:00:05] INFO: Officer #348 requesting weapon check-in ‚Äî sending to Weapon Registry",
            "[18:00:35] WARN: No response from Weapon Registry ‚Äî 30s timeout",
            "[18:01:00] INFO: Officer #349 requesting shift start ‚Äî sending to Officer Duty Service",
            "[18:01:30] WARN: No response from Officer Duty Service ‚Äî 30s timeout",
            "[18:02:00] ERROR: Both services unresponsive ‚Äî shift change blocked"
          ],
          "data": {
            "Officers Waiting (Off-Duty)": "200 (cannot return weapons)",
            "Officers Waiting (On-Duty)": "200 (cannot receive weapons)",
            "Services Responding": "0 of 2",
            "Shift Change Status": "COMPLETELY BLOCKED"
          },
          "status": "400 oficiais presos na troca de turno. Ambos os servi√ßos necess√°rios est√£o em deadlock."
        }
      },
      {
        "id": "lock-manager",
        "type": "database",
        "label": "Distributed Lock Store",
        "status": "degraded",
        "position": { "x": 325, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Redis Lock Store",
          "logs": [
            "[18:00:01] INFO: Lock granted ‚Äî weapon_assignment_347 ‚Üí Weapon Registry (no TTL)",
            "[18:00:01] INFO: Lock granted ‚Äî duty_status_347 ‚Üí Officer Duty Service (no TTL)",
            "[18:00:01] INFO: Lock request ‚Äî duty_status_347 ‚Üí Weapon Registry (QUEUED ‚Äî already held)",
            "[18:00:01] INFO: Lock request ‚Äî weapon_assignment_347 ‚Üí Officer Duty Service (QUEUED ‚Äî already held)",
            "[18:05:00] WARN: 2 locks held for >5 minutes with no release"
          ],
          "data": {
            "Active Locks": "2 (both stuck)",
            "Lock TTL": "NONE ‚Äî locks never expire",
            "Deadlock Detection": "NOT IMPLEMENTED",
            "Lock Order Enforcement": "NONE"
          },
          "status": "Dois locks mantidos indefinidamente. Sem TTL, sem detec√ß√£o de deadlock, sem ordena√ß√£o de locks."
        }
      }
    ],
    "edges": [
      { "id": "e-weapon-lock", "source": "weapon-registry", "target": "lock-manager", "label": "holds weapon lock, wants duty lock", "animated": false, "style": "slow" },
      { "id": "e-duty-lock", "source": "officer-duty", "target": "lock-manager", "label": "holds duty lock, wants weapon lock", "animated": false, "style": "slow" },
      { "id": "e-terminal-weapon", "source": "shift-terminal", "target": "weapon-registry", "label": "no response", "animated": false, "style": "broken" },
      { "id": "e-terminal-duty", "source": "shift-terminal", "target": "officer-duty", "label": "no response", "animated": false, "style": "broken" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz de ambos os servi√ßos estarem completamente congelados?",
      "options": [
        {
          "id": "rc-1",
          "text": "O lock store distribu√≠do (Redis) tem um bug que impede completamente que os locks sejam liberados",
          "correct": false,
          "feedback": "O Redis est√° funcionando corretamente ‚Äî concedeu os locks conforme solicitado e est√° fielmente aguardando os comandos de libera√ß√£o. O lock store est√° apenas fazendo o que foi mandado. O problema √© a ordem em que os servi√ßos adquirem os locks: cada um pega um lock e tenta pegar o outro, criando uma espera circular."
        },
        {
          "id": "rc-2",
          "text": "Um deadlock distribu√≠do ‚Äî dois servi√ßos cada um mantendo um lock que o outro precisa, sem timeout ou ordena√ß√£o para quebrar o ciclo",
          "correct": true,
          "feedback": "Correto! Este √© um deadlock cl√°ssico com todas as quatro condi√ß√µes de Coffman satisfeitas: exclus√£o m√∫tua (locks s√£o exclusivos), manter e esperar (cada servi√ßo mant√©m um lock enquanto espera pelo outro), sem preemp√ß√£o (locks n√£o podem ser tomados √† for√ßa), e espera circular (A espera B, B espera A). A falta de timeouts nos locks significa que nenhum servi√ßo jamais desistir√°, e a falta de uma ordena√ß√£o consistente de locks permite que a depend√™ncia circular se forme."
        },
        {
          "id": "rc-3",
          "text": "Os servi√ßos crasharam mas seus locks n√£o foram liberados porque os locks n√£o t√™m TTL configurado",
          "correct": false,
          "feedback": "Os servi√ßos n√£o crasharam ‚Äî ainda est√£o rodando com 100% de utiliza√ß√£o de threads. Est√£o vivos mas bloqueados, o que na verdade √© pior que um crash (um crash pelo menos seria detectado por health checks). As threads est√£o dormindo, esperando por locks que nunca vir√£o."
        },
        {
          "id": "rc-4",
          "text": "O processo de troca de turno envia muitas requisi√ß√µes concorrentes, sobrecarregando o lock store Redis",
          "correct": false,
          "feedback": "O lock store n√£o est√° sobrecarregado ‚Äî tem apenas 2 locks ativos. O problema n√£o √© volume, √© a ordena√ß√£o de aquisi√ß√£o de locks. At√© mesmo um √∫nico par de requisi√ß√µes pode causar deadlock se dois servi√ßos adquirem locks em ordens opostas."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor abordagem para prevenir deadlocks distribu√≠dos?",
      "options": [
        {
          "id": "fix-1",
          "text": "Adicionar mais threads a ambos os servi√ßos para que algumas permane√ßam dispon√≠veis quando outras bloqueiam",
          "correct": false,
          "feedback": "Mais threads significa apenas mais threads que podem participar de deadlocks. As threads em deadlock nunca ser√£o liberadas ‚Äî adicionar mais apenas adia o ponto em que todas as threads s√£o consumidas. Voc√™ precisa prevenir ou quebrar o deadlock em si."
        },
        {
          "id": "fix-2",
          "text": "Estabelecer uma ordena√ß√£o global de locks ‚Äî todos os servi√ßos devem adquirir locks na mesma ordem consistente, e adicionar timeouts nos locks (TTL) como rede de seguran√ßa",
          "correct": true,
          "feedback": "Correto! Ordena√ß√£o consistente de locks quebra a condi√ß√£o de espera circular. Se todos os servi√ßos sempre adquirem o lock de plant√£o antes do lock de arma (ou vice-versa), dois servi√ßos nunca podem acabar cada um segurando o que o outro precisa. Timeouts nos locks (TTL) adicionam uma rede de seguran√ßa ‚Äî se um deadlock de alguma forma ocorrer, os locks expiram e liberam os servi√ßos. Juntos, estes previnem deadlocks e limitam seu impacto caso um escape."
        },
        {
          "id": "fix-3",
          "text": "Remover o locking distribu√≠do completamente e usar controle de concorr√™ncia otimista com n√∫meros de vers√£o",
          "correct": false,
          "feedback": "Concorr√™ncia otimista funciona bem para cen√°rios de baixa conten√ß√£o, mas atribui√ß√µes de armas durante troca de turno t√™m alta conten√ß√£o ‚Äî 400 oficiais simultaneamente. Voc√™ veria conflitos e retries constantes. A melhor abordagem √© manter o locking mas estabelecer ordena√ß√£o e adicionar timeouts."
        },
        {
          "id": "fix-4",
          "text": "Unificar o Registro de Armas e o Plant√£o dos Oficiais em um √∫nico servi√ßo para os locks serem locais",
          "correct": false,
          "feedback": "Embora a consolida√ß√£o elimine o aspecto distribu√≠do, deadlocks locais ainda podem ocorrer dentro de um √∫nico servi√ßo. Al√©m disso, unificar servi√ßos viola o princ√≠pio de responsabilidade √∫nica e cria um raio de explos√£o maior. A corre√ß√£o adequada ‚Äî ordena√ß√£o de locks e timeouts ‚Äî funciona tanto para deadlocks locais quanto distribu√≠dos."
        }
      ]
    }
  },
  "conceptId": "distributed-deadlocks",
  "badge": {
    "name": "Mestre das Fechaduras",
    "icon": "üîê"
  }
}