{
  "id": "case-31",
  "number": 31,
  "title": "A Leitura Fantasma",
  "subtitle": "As estat√≠sticas criminais que mudaram no meio da contagem",
  "brief": {
    "narrative": "A Comiss√°ria Data est√° apresentando as estat√≠sticas criminais trimestrais para a C√¢mara Municipal de Distributia. Os n√∫meros parecem √≥timos ‚Äî crimes violentos ca√≠ram 15%. Mas no meio da apresenta√ß√£o, a Vereadora Chen puxa o mesmo relat√≥rio do dashboard p√∫blico e contesta os n√∫meros: a c√≥pia dela mostra crimes violentos em alta de 3%. A Comiss√°ria roda o relat√≥rio novamente ao vivo no projetor ‚Äî e obt√©m um terceiro conjunto diferente de n√∫meros. O caos se instala. A investiga√ß√£o revela que o Servi√ßo de Relat√≥rios Estat√≠sticos l√™ de m√∫ltiplas tabelas ao longo de v√°rios segundos. Entre as leituras, o Servi√ßo de Registro de Crimes est√° ativamente inserindo novos registros e o Servi√ßo de Resolu√ß√£o de Casos est√° atualizando status de casos. A transa√ß√£o do relat√≥rio est√° usando isolamento READ COMMITTED, o que significa que cada consulta dentro do relat√≥rio v√™ os dados mais recentes j√° commitados ‚Äî mas esses dados est√£o mudando entre consultas. A contagem de crimes violentos foi lida √†s 10:00:01, mas a contagem de casos resolvidos foi lida √†s 10:00:04, momento em que 47 novos crimes j√° haviam sido registrados. O relat√≥rio est√° misturando dados de diferentes pontos no tempo, produzindo n√∫meros que nunca existiram simultaneamente.",
    "symptoms": [
      "O relat√≥rio de estat√≠sticas criminais produz resultados diferentes cada vez que √© executado dentro do mesmo minuto",
      "A contagem de crimes violentos e de casos resolvidos s√£o inconsistentes entre si",
      "Os n√∫meros do relat√≥rio n√£o batem com o dashboard p√∫blico (que executou a mesma consulta momentos depois)",
      "As consultas individuais est√£o corretas, mas o relat√≥rio combinado apresenta um snapshot imposs√≠vel"
    ],
    "objective": "Identificar como o n√≠vel de isolamento de transa√ß√£o incorreto causa leituras fantasma e relat√≥rios inconsistentes, e determinar o n√≠vel de isolamento correto para consultas anal√≠ticas."
  },
  "diagram": {
    "nodes": [
      {
        "id": "stats-service",
        "type": "server",
        "label": "Statistics Report Service",
        "status": "degraded",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Relat√≥rios Estat√≠sticos",
          "logs": [
            "[10:00:01] INFO: Starting quarterly report ‚Äî Transaction isolation: READ COMMITTED",
            "[10:00:01] INFO: Query 1 ‚Äî SELECT COUNT(*) FROM crimes WHERE type='violent' ‚Üí 1,247",
            "[10:00:02] INFO: Query 2 ‚Äî SELECT COUNT(*) FROM crimes WHERE type='property' ‚Üí 3,891",
            "[10:00:03] INFO: Query 3 ‚Äî SELECT COUNT(*) FROM cases WHERE status='resolved' ‚Üí 4,102",
            "[10:00:04] INFO: Query 4 ‚Äî SELECT COUNT(*) FROM crimes (total) ‚Üí 5,185",
            "[10:00:04] WARN: Data inconsistency ‚Äî violent(1,247) + property(3,891) = 5,138, but total = 5,185",
            "[10:00:04] INFO: Report generated ‚Äî but 47 crimes appeared between Query 1 and Query 4"
          ],
          "data": {
            "Isolation Level": "READ COMMITTED",
            "Transaction Duration": "3.2 seconds",
            "Queries Per Report": "12",
            "Snapshot Consistency": "NONE ‚Äî each query sees latest committed data",
            "Data Changed During Tx": "47 new crimes, 13 case updates"
          },
          "status": "O relat√≥rio monta dados de diferentes pontos no tempo. Cada consulta √© correta individualmente, mas o resultado combinado √© inconsistente."
        }
      },
      {
        "id": "crime-intake",
        "type": "server",
        "label": "Crime Intake Service",
        "status": "healthy",
        "position": { "x": 80, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Registro de Crimes",
          "logs": [
            "[10:00:01] INFO: INSERT crime #8291 ‚Äî type=violent ‚Äî COMMITTED",
            "[10:00:02] INFO: INSERT crime #8292 ‚Äî type=property ‚Äî COMMITTED",
            "[10:00:02] INFO: INSERT crime #8293 ‚Äî type=violent ‚Äî COMMITTED",
            "[10:00:03] INFO: INSERT crimes #8294-#8338 ‚Äî batch import from precinct 7 ‚Äî COMMITTED",
            "[10:00:04] INFO: INSERT crime #8339 ‚Äî type=property ‚Äî COMMITTED"
          ],
          "data": {
            "Inserts During Report Window": "47 new crime records",
            "Commit Rate": "~15 commits/second",
            "Status": "Operating normally ‚Äî unaware of concurrent report"
          },
          "status": "Inserindo ativamente novos registros de crimes. Cada insert √© imediatamente vis√≠vel para transa√ß√µes READ COMMITTED."
        }
      },
      {
        "id": "case-resolution",
        "type": "server",
        "label": "Case Resolution Service",
        "status": "healthy",
        "position": { "x": 620, "y": 200 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Resolu√ß√£o de Casos",
          "logs": [
            "[10:00:01] INFO: UPDATE case #4411 ‚Äî status='resolved' ‚Äî COMMITTED",
            "[10:00:02] INFO: UPDATE case #4415 ‚Äî status='resolved' ‚Äî COMMITTED",
            "[10:00:03] INFO: UPDATE cases #4420-#4432 ‚Äî batch resolution ‚Äî COMMITTED"
          ],
          "data": {
            "Updates During Report Window": "13 case status changes",
            "Status": "Operating normally",
            "Commit Rate": "~4 commits/second"
          },
          "status": "Atualizando ativamente status de casos. As mudan√ßas s√£o vis√≠veis para consultas subsequentes na transa√ß√£o do relat√≥rio."
        }
      },
      {
        "id": "crime-db",
        "type": "database",
        "label": "Crime Database",
        "status": "healthy",
        "position": { "x": 350, "y": 350 },
        "inspectable": true,
        "inspectData": {
          "title": "Banco de Dados de Estat√≠sticas Criminais",
          "logs": [
            "[10:00:01] INFO: Report transaction started ‚Äî isolation=READ_COMMITTED",
            "[10:00:01] INFO: Concurrent write transactions active: 8",
            "[10:00:04] INFO: Report transaction completed ‚Äî 12 queries executed",
            "[10:00:04] INFO: During report tx: 47 inserts, 13 updates committed by other transactions"
          ],
          "data": {
            "Isolation Level": "READ COMMITTED (default)",
            "MVCC": "Enabled but each statement sees latest snapshot",
            "Concurrent Transactions": "8 active writers during report",
            "Snapshot Isolation": "NOT ENABLED"
          },
          "status": "Banco de dados est√° saud√°vel. READ COMMITTED fornece consist√™ncia por instru√ß√£o, mas n√£o por transa√ß√£o."
        }
      }
    ],
    "edges": [
      { "id": "e-stats-db", "source": "stats-service", "target": "crime-db", "label": "12 queries (3.2s)", "animated": true, "style": "slow" },
      { "id": "e-intake-db", "source": "crime-intake", "target": "crime-db", "label": "47 inserts", "animated": true, "style": "normal" },
      { "id": "e-resolution-db", "source": "case-resolution", "target": "crime-db", "label": "13 updates", "animated": true, "style": "normal" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz do relat√≥rio de estat√≠sticas criminais estar inconsistente?",
      "options": [
        {
          "id": "rc-1",
          "text": "O Servi√ßo de Registro de Crimes est√° inserindo registros r√°pido demais, corrompendo os √≠ndices do banco de dados e causando inconsist√™ncias, o que impede que o relat√≥rio mostre dados precisos.",
          "correct": false,
          "feedback": "O banco de dados est√° funcionando perfeitamente ‚Äî sem corrup√ß√£o, sem bugs. Cada insert e update foi devidamente commitado. O problema √© que a transa√ß√£o do relat√≥rio v√™ dados commitados diferentes em momentos diferentes porque o isolamento READ COMMITTED d√° a cada consulta seu pr√≥prio snapshot."
        },
        {
          "id": "rc-2",
          "text": "O isolamento READ COMMITTED permite que cada consulta na transa√ß√£o do relat√≥rio veja dados rec√©m-commitados, causando leituras fantasma ao longo do relat√≥rio multi-consulta",
          "correct": true,
          "feedback": "Correto! Sob isolamento READ COMMITTED, cada instru√ß√£o SQL v√™ todos os dados commitados at√© o momento em que aquela instru√ß√£o come√ßa a executar. Como o relat√≥rio executa 12 consultas em 3,2 segundos, e outras transa√ß√µes est√£o commitando mudan√ßas entre essas consultas, cada consulta no relat√≥rio v√™ uma vers√£o ligeiramente diferente dos dados. Este √© o problema de leitura fantasma ‚Äî linhas que n√£o existiam quando a transa√ß√£o come√ßou 'aparecem' em consultas posteriores, produzindo um relat√≥rio que mistura dados de diferentes pontos no tempo."
        },
        {
          "id": "rc-3",
          "text": "As consultas do relat√≥rio est√£o mal escritas, n√£o fazem JOIN adequado nas tabelas e retornam dados inconsistentes por isso, impedindo que o relat√≥rio mostre dados precisos.",
          "correct": false,
          "feedback": "Cada consulta individual est√° correta e retorna resultados precisos no momento em que √© executada. A inconsist√™ncia surge porque os dados mudam entre consultas. SQL melhor n√£o ajudar√° se o n√≠vel de isolamento permite que os dados subjacentes mudem no meio da transa√ß√£o."
        },
        {
          "id": "rc-4",
          "text": "O banco de dados est√° sob carga excessiva, fazendo as consultas retornarem resultados desatualizados ou de cache em vez de dados reais",
          "correct": false,
          "feedback": "O banco de dados n√£o est√° retornando dados desatualizados ‚Äî muito pelo contr√°rio! Est√° retornando dados frescos demais. Cada consulta retorna o estado mais recente commitado, que inclui mudan√ßas feitas por outras transa√ß√µes desde que o relat√≥rio come√ßou. O problema √© que 'mais recente' muda entre consultas."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor solu√ß√£o para garantir que o relat√≥rio de estat√≠sticas criminais leia dados consistentes?",
      "options": [
        {
          "id": "fix-1",
          "text": "Usar n√≠vel de isolamento SERIALIZABLE para serializar completamente o acesso, bloqueando todas as outras transa√ß√µes enquanto o relat√≥rio executa",
          "correct": false,
          "feedback": "SERIALIZABLE forneceria consist√™ncia, mas √© excessivo e bloquearia todo o registro de crimes e resolu√ß√£o de casos pelos 3+ segundos que o relat√≥rio roda. Para uma consulta anal√≠tica somente leitura, voc√™ n√£o precisa bloquear escritores ‚Äî s√≥ precisa de um snapshot consistente de um ponto no tempo."
        },
        {
          "id": "fix-2",
          "text": "Executar todas as 12 consultas em uma √∫nica instru√ß√£o SQL com subqueries aninhadas para que todo o relat√≥rio execute atomicamente em um s√≥ snapshot",
          "correct": false,
          "feedback": "Combinar consultas em uma instru√ß√£o ajuda sob READ COMMITTED (uma instru√ß√£o = um snapshot), mas √© fr√°gil ‚Äî relat√≥rios complexos podem precisar de m√∫ltiplas instru√ß√µes, e essa abordagem falha para relat√≥rios que n√£o podem ser expressos como uma √∫nica query. A corre√ß√£o adequada √© no n√≠vel de isolamento."
        },
        {
          "id": "fix-3",
          "text": "Usar REPEATABLE READ ou isolamento SNAPSHOT para que todas as consultas na transa√ß√£o do relat√≥rio vejam o mesmo snapshot de um ponto no tempo",
          "correct": true,
          "feedback": "Correto! REPEATABLE READ (ou isolamento SNAPSHOT em bancos de dados que suportam) garante que todas as consultas dentro de uma transa√ß√£o vejam o banco de dados como ele estava no momento em que a transa√ß√£o come√ßou. Novos inserts e updates commitados por outras transa√ß√µes s√£o invis√≠veis para o relat√≥rio. Isso elimina leituras fantasma ‚Äî o relat√≥rio v√™ um snapshot consistente mesmo que os dados subjacentes estejam sendo modificados. Escritores n√£o s√£o bloqueados, ent√£o o sistema permanece totalmente operacional."
        },
        {
          "id": "fix-4",
          "text": "Adicionar um lock exclusivo na tabela de crimes antes de gerar o relat√≥rio para impedir que qualquer modifica√ß√£o concorrente ocorra durante a leitura",
          "correct": false,
          "feedback": "Lock em n√≠vel de tabela forneceria consist√™ncia mas bloquearia todo o registro de crimes durante a gera√ß√£o do relat√≥rio ‚Äî inaceit√°vel para um departamento de pol√≠cia onde cada segundo conta. O isolamento SNAPSHOT alcan√ßa a mesma consist√™ncia sem bloquear nenhum escritor atrav√©s de MVCC (Multi-Version Concurrency Control)."
        }
      ]
    }
  },
  "conceptId": "isolation-levels",
  "badge": {
    "name": "Especialista em Isolamento",
    "icon": "üî¨"
  }
}