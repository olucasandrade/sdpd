{
  "id": "case-32",
  "number": 32,
  "title": "A Falha da Saga",
  "subtitle": "Um processo de registro que esqueceu como desfazer seus erros",
  "brief": {
    "narrative": "Uma grande opera√ß√£o antidrogas na DP de Distributia traz 15 suspeitos de uma vez. O Sistema de Registro entra em ritmo acelerado, processando cada pris√£o atrav√©s de um pipeline de tr√™s etapas: Etapa 1 ‚Äî criar um registro de pris√£o no Servi√ßo de Pris√£o, Etapa 2 ‚Äî gerar um n√∫mero de registro no Servi√ßo de Booking, Etapa 3 ‚Äî atribuir uma cela de deten√ß√£o no Servi√ßo de Atribui√ß√£o de Celas. O Suspeito #7 passa pelas Etapas 1 e 2 sem problemas, mas a Etapa 3 falha ‚Äî o Servi√ßo de Atribui√ß√£o de Celas n√£o tem celas dispon√≠veis (capacidade atingida). O sistema lan√ßa um erro e desiste. Mas eis a cat√°strofe: o registro de pris√£o da Etapa 1 ainda existe, e o n√∫mero de booking da Etapa 2 j√° foi atribu√≠do. O Suspeito #7 agora √© um fantasma no sistema ‚Äî oficialmente preso e registrado, mas sem cela atribu√≠da. A pris√£o n√£o pode ser reprocessada porque o n√∫mero de booking j√° est√° em uso. O registro n√£o pode ser deletado manualmente porque est√° marcado como pris√£o ativa. Enquanto isso, a contagem de celas mostra capacidade m√°xima, mas uma dessas celas 'ocupadas' foi pr√©-alocada para o Suspeito #7 e est√° fisicamente vazia. O Sargento Saga est√° olhando para uma transa√ß√£o meio-completa sem mecanismo de rollback e sem caminho √† frente.",
    "symptoms": [
      "O Suspeito #7 tem um registro de pris√£o e n√∫mero de booking mas nenhuma atribui√ß√£o de cela",
      "Reexecutar o booking falha ‚Äî n√∫mero de booking j√° alocado",
      "A capacidade de celas mostra lota√ß√£o m√°xima, mas uma cela reservada est√° fisicamente vazia",
      "Nenhuma a√ß√£o compensat√≥ria ou rollback ocorreu ap√≥s a falha da Etapa 3"
    ],
    "objective": "Identificar por que um processo distribu√≠do de m√∫ltiplas etapas deixou dados em estado inconsistente, e determinar o padr√£o correto para gerenciar transa√ß√µes distribu√≠das de longa dura√ß√£o."
  },
  "diagram": {
    "nodes": [
      {
        "id": "booking-orchestrator",
        "type": "server",
        "label": "Booking Orchestrator",
        "status": "failed",
        "position": { "x": 350, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "Orquestrador de Booking",
          "logs": [
            "[21:15:00] INFO: Starting booking saga for Suspect #7 (Arrest ID: A-2847)",
            "[21:15:01] INFO: Step 1 ‚Äî Arrest Service ‚Üí CREATE arrest record ‚Üí SUCCESS",
            "[21:15:02] INFO: Step 2 ‚Äî Booking Service ‚Üí ASSIGN booking number ‚Üí SUCCESS (BK-90441)",
            "[21:15:03] INFO: Step 3 ‚Äî Cell Assignment ‚Üí ASSIGN cell ‚Üí FAILED (capacity exceeded)",
            "[21:15:03] ERROR: Step 3 failed. No compensating transactions defined.",
            "[21:15:03] ERROR: Saga aborted ‚Äî system left in inconsistent state",
            "[21:15:03] ERROR: Manual intervention required for Arrest A-2847, Booking BK-90441"
          ],
          "data": {
            "Saga Status": "FAILED ‚Äî INCONSISTENT STATE",
            "Steps Completed": "2 of 3",
            "Steps Rolled Back": "0 of 2 (NO COMPENSATING ACTIONS DEFINED)",
            "Orphaned Records": "Arrest A-2847, Booking BK-90441",
            "Rollback Strategy": "NONE IMPLEMENTED"
          },
          "status": "Saga falhou na Etapa 3 mas n√£o tem transa√ß√µes compensat√≥rias para desfazer as Etapas 1 e 2."
        }
      },
      {
        "id": "arrest-service",
        "type": "server",
        "label": "Arrest Service",
        "status": "degraded",
        "position": { "x": 80, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Pris√£o",
          "logs": [
            "[21:15:01] INFO: Created arrest record A-2847 for Suspect #7",
            "[21:15:01] INFO: Status: ACTIVE ‚Äî awaiting booking",
            "[21:15:04] WARN: Arrest A-2847 still in ACTIVE state ‚Äî no booking completion received",
            "[21:20:00] WARN: Arrest A-2847 stuck in ACTIVE for 5 minutes ‚Äî no rollback requested"
          ],
          "data": {
            "Arrest ID": "A-2847",
            "Suspect": "#7",
            "Status": "ACTIVE (cannot be deleted or reprocessed)",
            "Compensating Action": "NOT DEFINED",
            "Expected Next Step": "Booking confirmation (never arrived)"
          },
          "status": "Registro de pris√£o existe e est√° marcado como ATIVO. Nenhuma a√ß√£o compensat√≥ria para anul√°-lo."
        }
      },
      {
        "id": "booking-service",
        "type": "server",
        "label": "Booking Service",
        "status": "degraded",
        "position": { "x": 350, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Booking",
          "logs": [
            "[21:15:02] INFO: Assigned booking number BK-90441 to Arrest A-2847",
            "[21:15:02] INFO: Status: ALLOCATED ‚Äî awaiting cell assignment",
            "[21:15:05] WARN: Booking BK-90441 ‚Äî no cell assignment confirmation received",
            "[21:20:00] WARN: Booking BK-90441 stuck in ALLOCATED for 5 minutes"
          ],
          "data": {
            "Booking Number": "BK-90441",
            "Linked Arrest": "A-2847",
            "Status": "ALLOCATED (blocks re-use of this number)",
            "Compensating Action": "NOT DEFINED",
            "Expected Next Step": "Cell assignment (never arrived)"
          },
          "status": "N√∫mero de booking alocado mas nunca finalizado. O n√∫mero n√£o pode ser reutilizado ou liberado."
        }
      },
      {
        "id": "cell-assignment",
        "type": "server",
        "label": "Cell Assignment",
        "status": "failed",
        "position": { "x": 620, "y": 250 },
        "inspectable": true,
        "inspectData": {
          "title": "Servi√ßo de Atribui√ß√£o de Celas",
          "logs": [
            "[21:15:03] INFO: Cell assignment request for Booking BK-90441",
            "[21:15:03] ERROR: All holding cells at capacity (48/48 occupied)",
            "[21:15:03] ERROR: Cell assignment FAILED ‚Äî no available cells",
            "[21:15:03] INFO: Note: Cell #12 was pre-reserved for BK-90441 but reservation failed on final commit"
          ],
          "data": {
            "Capacity": "48/48 (includes 1 ghost reservation)",
            "Cell #12": "Reserved for BK-90441 but physically EMPTY",
            "Assignment Status": "FAILED",
            "Compensating Action": "NOT DEFINED"
          },
          "status": "Atribui√ß√£o falhou mas uma pr√©-reserva existe que n√£o ser√° liberada."
        }
      }
    ],
    "edges": [
      { "id": "e-orch-arrest", "source": "booking-orchestrator", "target": "arrest-service", "label": "Step 1: SUCCESS", "animated": false, "style": "normal" },
      { "id": "e-orch-booking", "source": "booking-orchestrator", "target": "booking-service", "label": "Step 2: SUCCESS", "animated": false, "style": "normal" },
      { "id": "e-orch-cell", "source": "booking-orchestrator", "target": "cell-assignment", "label": "Step 3: FAILED", "animated": false, "style": "broken" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz dos dados inconsistentes ap√≥s a falha do booking?",
      "options": [
        {
          "id": "rc-1",
          "text": "O Servi√ßo de Atribui√ß√£o de Celas tem um bug de software interno que reporta a capacidade de deten√ß√£o como cheia, de forma equivocada, mesmo quando existem celas dispon√≠veis.",
          "correct": false,
          "feedback": "O problema de capacidade √© uma falha leg√≠tima ‚Äî as celas realmente est√£o cheias (com uma reserva fantasma). O problema real n√£o √© que a Etapa 3 falhou. Falhas s√£o esperadas em sistemas distribu√≠dos. O problema √© que n√£o existem a√ß√µes compensat√≥rias para desfazer as Etapas 1 e 2 quando a Etapa 3 falha."
        },
        {
          "id": "rc-2",
          "text": "A transa√ß√£o distribu√≠da de m√∫ltiplas etapas n√£o tem a√ß√µes compensat√≥rias (rollback de saga), ent√£o uma falha no meio deixa as etapas completas em estado inconsistente",
          "correct": true,
          "feedback": "Correto! Em um sistema distribu√≠do, voc√™ n√£o pode usar uma transa√ß√£o ACID tradicional entre m√∫ltiplos servi√ßos. O padr√£o Saga resolve isso definindo a√ß√µes compensat√≥rias para cada etapa: se a Etapa 3 falha, execute 'desfazer Etapa 2' (liberar o n√∫mero de booking) e depois 'desfazer Etapa 1' (anular o registro de pris√£o). Sem essas transa√ß√µes compensat√≥rias, uma falha em qualquer ponto da cadeia deixa dados √≥rf√£os e inconsistentes que requerem interven√ß√£o manual."
        },
        {
          "id": "rc-3",
          "text": "Os tr√™s servi√ßos deveriam compartilhar um √∫nico banco de dados centralizado para que uma transa√ß√£o ACID tradicional fizesse rollback de tudo, evitando assim inconsist√™ncias.",
          "correct": false,
          "feedback": "Um banco de dados compartilhado permitiria uma √∫nica transa√ß√£o ACID, mas isso anula o prop√≥sito dos microsservi√ßos (deploy independente, escalabilidade e propriedade). Em uma arquitetura de microsservi√ßos, cada servi√ßo √© dono dos seus dados. O padr√£o Saga √© a solu√ß√£o padr√£o para manter consist√™ncia atrav√©s de fronteiras de servi√ßo."
        },
        {
          "id": "rc-4",
          "text": "O Orquestrador de Booking deveria ter verificado de forma abrangente a disponibilidade de celas em todas as instala√ß√µes antes de iniciar o processo",
          "correct": false,
          "feedback": "Pr√©-verificar disponibilidade ajuda mas n√£o resolve o problema fundamental. Uma cela pode ser ocupada entre a verifica√ß√£o e a atribui√ß√£o (uma condi√ß√£o de corrida). Qualquer etapa em qualquer processo distribu√≠do pode falhar a qualquer momento. Voc√™ deve planejar para falhas e ter a√ß√µes compensat√≥rias prontas ‚Äî este √© o padr√£o Saga."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor abordagem para lidar com falhas em processos distribu√≠dos de m√∫ltiplas etapas?",
      "options": [
        {
          "id": "fix-1",
          "text": "Implementar o padr√£o Saga com transa√ß√µes compensat√≥rias ‚Äî cada etapa define uma a√ß√£o de desfazer que √© executada se uma etapa posterior falhar",
          "correct": true,
          "feedback": "Correto! O padr√£o Saga divide uma transa√ß√£o distribu√≠da em uma sequ√™ncia de transa√ß√µes locais, cada uma com uma a√ß√£o compensat√≥ria. Se a Etapa 3 (atribui√ß√£o de cela) falha, o orquestrador automaticamente aciona: 'compensar Etapa 2' (liberar n√∫mero de booking BK-90441) e 'compensar Etapa 1' (anular registro de pris√£o A-2847). Isso garante que o sistema retorne a um estado consistente. Sagas podem ser orquestradas (coordenador central) ou coreografadas (orientadas a eventos), e s√£o o padr√£o standard para transa√ß√µes distribu√≠das em arquiteturas de microsservi√ßos."
        },
        {
          "id": "fix-2",
          "text": "Usar um protocolo de two-phase commit (2PC) para garantir que todos os tr√™s servi√ßos sincronamente fa√ßam commit ou abort juntos",
          "correct": false,
          "feedback": "Two-phase commit fornece atomicidade mas tem s√©rias desvantagens em microsservi√ßos: requer que todos os participantes estejam dispon√≠veis simultaneamente, mant√©m locks entre servi√ßos durante a fase de prepara√ß√£o (bloqueante), e uma falha do coordenador pode deixar participantes presos em um estado preparado. Sagas s√£o preferidas em arquiteturas de microsservi√ßos porque s√£o mais resilientes e n√£o requerem locking entre servi√ßos."
        },
        {
          "id": "fix-3",
          "text": "Adicionar l√≥gica de retry exponencial autom√°tico para que se a Etapa 3 falhar, o orquestrador tente novamente at√© uma cela liberar",
          "correct": false,
          "feedback": "Fazer retry indefinidamente √© problem√°tico ‚Äî e se nenhuma cela ficar dispon√≠vel por horas? Enquanto isso, os registros de pris√£o e booking est√£o em um estado de limbo. Retries s√£o √∫teis para falhas transientes, mas para falhas de l√≥gica de neg√≥cio (sem capacidade), voc√™ precisa de transa√ß√µes compensat√≥rias para desfazer o trabalho parcial de forma limpa."
        },
        {
          "id": "fix-4",
          "text": "Reservar todos os recursos necess√°rios antecipadamente ‚Äî slot de pris√£o, n√∫mero, e cela ‚Äî antes de tentar executar qualquer etapa",
          "correct": false,
          "feedback": "Reserva ajuda mas n√£o elimina o problema ‚Äî uma reserva pode falhar, um recurso reservado pode expirar, ou o processo pode falhar entre reservas. Voc√™ ainda precisa de a√ß√µes compensat√≥rias para quando as coisas d√£o errado. O padr√£o Saga lida com todos os cen√°rios de falha sistematicamente."
        }
      ]
    }
  },
  "conceptId": "sagas",
  "badge": {
    "name": "Mestre da Saga",
    "icon": "üìú"
  }
}