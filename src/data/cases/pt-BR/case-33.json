{
  "id": "case-33",
  "number": 33,
  "title": "O Rate Limiter",
  "subtitle": "Uma integra√ß√£o inunda o sistema, afogando todos os outros",
  "brief": {
    "narrative": "A DP de Distributia recentemente se integrou com o Banco de Dados Federal de Mandados ‚Äî uma grande conquista para coopera√ß√£o interjurisdicional. A integra√ß√£o funciona atrav√©s da API do Warrant Gateway, que todas as cinco delegacias usam para verificar mandados federais durante paradas de tr√¢nsito e pris√µes. Tudo estava bem durante os testes com um punhado de requisi√ß√µes. Mas esta manh√£, a 3a Delegacia deployou um sistema automatizado de checagem de antecedentes que consulta o Warrant Gateway para cada pessoa nos seus registros ‚Äî todas as 140.000 ‚Äî em um job em lote que dispara 500 requisi√ß√µes por segundo. O Warrant Gateway n√£o tem rate limiting. Em minutos, a API ficou t√£o sobrecarregada que as 1a, 2a, 4a e 5a Delegacias n√£o conseguem fazer verifica√ß√µes de mandados. Oficiais em campo est√£o fazendo paradas de tr√¢nsito e pris√µes sem saber se a pessoa tem um mandado federal. A Oficial Shield da 1a Delegacia acabou de liberar um suspeito durante uma parada de rotina que, sem ela saber, tem um mandado federal ativo por roubo √† m√£o armada. O job em lote de uma delegacia monopolizou um recurso compartilhado, deixando todas as outras delegacias sem acesso.",
    "symptoms": [
      "Os tempos de resposta da API do Warrant Gateway excedem 30 segundos (normalmente 200ms)",
      "As 1a, 2a, 4a e 5a Delegacias reportam falhas na verifica√ß√£o de mandados ‚Äî timeouts em todas as requisi√ß√µes",
      "A 3a Delegacia est√° enviando 500 requisi√ß√µes/segundo via job automatizado em lote",
      "A vaz√£o total da API colapsou ‚Äî atendendo menos requisi√ß√µes do que antes do job em lote come√ßar"
    ],
    "objective": "Identificar como a aus√™ncia de rate limiting permitiu que um consumidor monopolizasse uma API compartilhada, e determinar a estrat√©gia correta de rate limiting para garantir acesso justo."
  },
  "diagram": {
    "nodes": [
      {
        "id": "precinct-3",
        "type": "client",
        "label": "Precinct 3 (batch job)",
        "status": "degraded",
        "position": { "x": 80, "y": 50 },
        "inspectable": true,
        "inspectData": {
          "title": "3a Delegacia ‚Äî Sistema Automatizado de Checagem de Antecedentes",
          "logs": [
            "[08:00:00] INFO: Starting batch warrant check ‚Äî 140,000 records queued",
            "[08:00:01] INFO: Sending 500 requests/second to Warrant Gateway",
            "[08:00:30] INFO: 15,000 records checked ‚Äî 0 throttle errors",
            "[08:01:00] WARN: Response times increasing ‚Äî 2s average (was 200ms)",
            "[08:02:00] WARN: Response times now 15s ‚Äî but no rate limit errors received",
            "[08:03:00] INFO: 45,000 records checked ‚Äî continuing at full speed"
          ],
          "data": {
            "Request Rate": "500/sec (unlimited)",
            "Records To Process": "140,000",
            "Rate Limit Received": "NONE ‚Äî no limits enforced",
            "Job Priority": "Background batch ‚Äî not time-sensitive",
            "Impact Awareness": "None ‚Äî no feedback that other precincts are affected"
          },
          "status": "Job em lote rodando a toda velocidade sem feedback de rate limiting. Sem consci√™ncia de que est√° deixando outras delegacias sem acesso."
        }
      },
      {
        "id": "other-precincts",
        "type": "client",
        "label": "Precincts 1,2,4,5",
        "status": "failed",
        "position": { "x": 80, "y": 300 },
        "inspectable": true,
        "inspectData": {
          "title": "1a, 2a, 4a e 5a Delegacias ‚Äî Opera√ß√µes de Campo",
          "logs": [
            "[08:01:15] INFO: [P1] Officer Shield ‚Äî warrant check for traffic stop suspect",
            "[08:01:45] ERROR: [P1] Warrant Gateway timeout ‚Äî 30s ‚Äî returning NO DATA",
            "[08:01:46] WARN: [P1] Officer Shield releasing suspect ‚Äî no warrant data available",
            "[08:02:00] ERROR: [P2] Warrant check failed ‚Äî timeout",
            "[08:02:10] ERROR: [P4] Warrant check failed ‚Äî timeout",
            "[08:02:30] ERROR: [P5] Warrant check failed ‚Äî 3 consecutive timeouts"
          ],
          "data": {
            "Combined Request Rate": "~20/sec (normal field operations)",
            "Success Rate": "0% (all timing out)",
            "Officers In Field": "340 (across 4 precincts)",
            "Warrant Checks Failed": "127 in last 5 minutes",
            "Safety Risk": "HIGH ‚Äî suspects released without warrant data"
          },
          "status": "Todas as quatro delegacias sem conseguir fazer verifica√ß√µes de mandados. Oficiais fazendo paradas sem informa√ß√µes cr√≠ticas de seguran√ßa."
        }
      },
      {
        "id": "warrant-gateway",
        "type": "server",
        "label": "Warrant Gateway API",
        "status": "failed",
        "position": { "x": 400, "y": 180 },
        "inspectable": true,
        "inspectData": {
          "title": "API do Warrant Gateway",
          "logs": [
            "[08:00:00] INFO: Incoming request rate: ~20/sec (normal)",
            "[08:00:01] WARN: Request rate spike ‚Äî 520/sec",
            "[08:00:30] WARN: Thread pool 95% utilized ‚Äî 190/200 threads busy",
            "[08:01:00] ERROR: Thread pool exhausted ‚Äî 200/200 threads busy",
            "[08:01:00] ERROR: Request queue overflow ‚Äî dropping requests",
            "[08:01:00] WARN: Rate limiting: NOT CONFIGURED"
          ],
          "data": {
            "Max Throughput": "200 req/sec",
            "Current Inbound": "520 req/sec",
            "Rate Limiting": "NONE",
            "Per-Client Quotas": "NONE",
            "Priority Queues": "NONE",
            "Precinct 3 Share": "96% of all requests",
            "Other Precincts Share": "4% of all requests"
          },
          "status": "API sobrecarregada. Sem rate limiting, sem cotas por cliente, sem diferencia√ß√£o de prioridade."
        }
      },
      {
        "id": "federal-db",
        "type": "database",
        "label": "Federal Warrant DB",
        "status": "degraded",
        "position": { "x": 650, "y": 180 },
        "inspectable": true,
        "inspectData": {
          "title": "Banco de Dados Federal de Mandados",
          "logs": [
            "[08:00:30] WARN: Query rate exceeding recommended threshold",
            "[08:01:00] WARN: Connection pool 90% utilized",
            "[08:01:30] ERROR: Query latency 5x normal ‚Äî resource contention"
          ],
          "data": {
            "Connection Pool": "180/200 (90% ‚Äî mostly Precinct 3 queries)",
            "Query Latency": "1.2s (normal: 50ms)",
            "Recommended Rate": "100 queries/sec",
            "Actual Rate": "500+ queries/sec"
          },
          "status": "Banco de dados sob carga pesada de consultas em lote sem throttling."
        }
      }
    ],
    "edges": [
      { "id": "e-p3-gateway", "source": "precinct-3", "target": "warrant-gateway", "label": "500 req/sec (no limit)", "animated": true, "style": "slow" },
      { "id": "e-others-gateway", "source": "other-precincts", "target": "warrant-gateway", "label": "20 req/sec (starved)", "animated": false, "style": "broken" },
      { "id": "e-gateway-db", "source": "warrant-gateway", "target": "federal-db", "label": "overwhelmed", "animated": true, "style": "slow" }
    ]
  },
  "diagnosis": {
    "rootCause": {
      "question": "Qual √© a causa raiz de quatro delegacias perderem acesso √†s verifica√ß√µes de mandados?",
      "options": [
        {
          "id": "rc-1",
          "text": "O job em lote da 3a Delegacia √© malicioso e n√£o deveria ter sido deployado sem aprova√ß√£o",
          "correct": false,
          "feedback": "O job em lote da 3a Delegacia √© um caso de uso leg√≠timo ‚Äî checagem de antecedentes contra mandados federais. O job n√£o √© malicioso; est√° simplesmente consumindo um recurso ilimitado sem restri√ß√µes. Sem rate limits, qualquer cliente pode monopolizar a API sem querer. O sistema deveria se proteger disso, n√£o depender de clientes bem-comportados."
        },
        {
          "id": "rc-2",
          "text": "O Banco de Dados Federal de Mandados √© lento demais para lidar com o volume de requisi√ß√µes",
          "correct": false,
          "feedback": "O banco de dados lidaria com a carga normal de 20 requisi√ß√µes/segundo tranquilamente. At√© os 500 req/seg da 3a Delegacia poderiam ser gerenci√°veis se propriamente enfileirados e throttled. O problema √© que o API gateway n√£o tem mecanismo para controlar o fluxo, ent√£o o volume bruto sem throttling esmaga tanto o gateway quanto o banco de dados."
        },
        {
          "id": "rc-3",
          "text": "O Warrant Gateway n√£o tem rate limiting ou cotas por cliente, permitindo que um consumidor monopolize a API compartilhada e deixe todos os outros sem acesso",
          "correct": true,
          "feedback": "Correto! Sem rate limiting, o Warrant Gateway trata todas as requisi√ß√µes igualmente em uma base de primeiro a chegar, primeiro a ser atendido. Os 500 req/seg da 3a Delegacia consomem 96% da capacidade da API, deixando migalhas para as outras quatro delegacias. Este √© o problema do 'vizinho barulhento' ‚Äî o uso de um tenant degrada o servi√ßo para todos os outros. Rate limiting com cotas por cliente garante acesso justo a recursos compartilhados."
        },
        {
          "id": "rc-4",
          "text": "O pool de threads do Warrant Gateway √© pequeno demais e deveria ser aumentado para lidar com picos de carga",
          "correct": false,
          "feedback": "Um pool de threads maior aumentaria a capacidade bruta, mas sem rate limiting, a 3a Delegacia simplesmente consumiria a capacidade extra tamb√©m. Se voc√™ adicionar 1000 threads, o job em lote alegremente usaria todas as 1000. Rate limiting √© essencial para garantir distribui√ß√£o justa de qualquer capacidade que exista."
        }
      ]
    },
    "fix": {
      "question": "Qual √© a melhor abordagem para evitar que um consumidor monopolize a API?",
      "options": [
        {
          "id": "fix-1",
          "text": "Bloquear o job em lote da 3a Delegacia e exigir que todas as verifica√ß√µes de mandados sejam manuais, uma por vez",
          "correct": false,
          "feedback": "Bloquear casos de uso leg√≠timos n√£o √© a resposta. Verifica√ß√µes de mandados em lote s√£o valiosas ‚Äî voc√™ s√≥ precisa limit√°-las. Uma boa estrat√©gia de rate limiting permite que jobs em lote rodem a uma taxa controlada sem impactar opera√ß√µes em tempo real."
        },
        {
          "id": "fix-2",
          "text": "Implementar rate limiting por cliente com cotas ‚Äî cada delegacia recebe uma parcela justa, com prioridade maior para requisi√ß√µes de campo em tempo real sobre opera√ß√µes em lote",
          "correct": true,
          "feedback": "Correto! Rate limiting por cliente (ex.: usando algoritmo de token bucket ou janela deslizante) garante que cada delegacia receba uma cota justa. N√≠veis de prioridade adicionam outra dimens√£o: requisi√ß√µes de campo em tempo real (seguran√ßa do oficial) recebem prioridade maior que jobs em lote de background. Desta forma, o job em lote da 3a Delegacia roda a uma taxa sustent√°vel (ex.: 50 req/seg em vez de 500), enquanto oficiais de campo de todas as delegacias recebem respostas em menos de um segundo. Rate limiting protege recursos compartilhados do problema do vizinho barulhento."
        },
        {
          "id": "fix-3",
          "text": "Escalar o Warrant Gateway horizontalmente para lidar com qualquer volume de requisi√ß√µes de qualquer cliente",
          "correct": false,
          "feedback": "Escalar ajuda com capacidade, mas sem rate limiting, um √∫nico cliente sempre poderia escalar suas requisi√ß√µes para acompanhar. Al√©m disso, o Banco de Dados Federal de Mandados tem seus pr√≥prios limites que voc√™ n√£o controla. Rate limiting √© essencial independentemente de quanto voc√™ escale ‚Äî √© sobre justi√ßa e prote√ß√£o, n√£o apenas capacidade."
        },
        {
          "id": "fix-4",
          "text": "Adicionar uma fila na frente do Warrant Gateway que processa requisi√ß√µes em ordem FIFO",
          "correct": false,
          "feedback": "Uma fila FIFO sem rate limiting ainda deixa a 3a Delegacia encher a fila com 500 req/seg, empurrando as requisi√ß√µes das outras delegacias para o final. A profundidade da fila cresceria ilimitadamente, e oficiais de campo esperariam atr√°s de dezenas de milhares de requisi√ß√µes em lote. Voc√™ precisa de cotas por cliente para garantir acesso justo."
        }
      ]
    }
  },
  "conceptId": "rate-limiting",
  "badge": {
    "name": "Guardi√£o de Rate Limit",
    "icon": "üö¶"
  }
}